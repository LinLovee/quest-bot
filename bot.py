"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                            â•‘
â•‘        ðŸŽ® RUNEQUESTRPG BOT - ÐŸÐžÐ›ÐÐžÐ¤Ð£ÐÐšÐ¦Ð˜ÐžÐÐÐ›Ð¬ÐÐÐ¯ RPG Ð’ TELEGRAM ðŸŽ®        â•‘
â•‘                                                                            â•‘
â•‘  Ð’ÐµÑ€ÑÐ¸Ñ: 4.0 ULTIMATE (7000+ ÑÑ‚Ñ€Ð¾Ðº ÐºÐ¾Ð´Ð°)                                   â•‘
â•‘  Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: âœ… ÐŸÐžÐ›ÐÐžÐ¡Ð¢Ð¬Ð® Ð¤Ð£ÐÐšÐ¦Ð˜ÐžÐÐÐ›Ð•Ð Ð˜ ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—Ð˜Ð ÐžÐ’ÐÐ                         â•‘
â•‘  ÐÐ²Ñ‚Ð¾Ñ€: AI Developer                                                       â•‘
â•‘  Ð”Ð°Ñ‚Ð°: 2024-2025                                                           â•‘
â•‘  Ð¯Ð·Ñ‹Ðº: Python 3.10+                                                        â•‘
â•‘  Ð¤Ñ€ÐµÐ¹Ð¼Ð²Ð¾Ñ€Ðº: python-telegram-bot 3.0+                                       â•‘
â•‘                                                                            â•‘
â•‘  Ð¡Ð¸ÑÑ‚ÐµÐ¼Ñ‹:                                                                  â•‘
â•‘  âœ… Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¸ Ð²Ñ‹Ð±Ð¾Ñ€ ÐºÐ»Ð°ÑÑÐ°                                             â•‘
â•‘  âœ… ÐŸÐ¾Ð»Ð½Ð°Ñ Ð±Ð¾ÐµÐ²Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ñ Ð±Ð¾ÑÑÐ°Ð¼Ð¸                                        â•‘
â•‘  âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ Ð¸ ÑÐºÐ¸Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸                                         â•‘
â•‘  âœ… ÐšÑ€Ð°Ñ„Ñ‚Ð¸Ð½Ð³ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð² (40+ Ñ€ÐµÑ†ÐµÐ¿Ñ‚Ð¾Ð²)                                      â•‘
â•‘  âœ… 7 Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¹ Ñ ÑƒÑ€Ð¾Ð²Ð½ÑÐ¼Ð¸                                                   â•‘
â•‘  âœ… Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð»Ð¸Ð´ÐµÑ€Ð¾Ð² Ñ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð¼                                 â•‘
â•‘  âœ… Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð²Ð¾Ðµ Ð¿Ð¾Ð´Ð·ÐµÐ¼ÐµÐ»ÑŒÐµ (Ð±ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼)                             â•‘
â•‘  âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¿Ð¸Ñ‚Ð¾Ð¼Ñ†ÐµÐ² Ñ Ð±Ð¾Ð½ÑƒÑÐ°Ð¼Ð¸                                            â•‘
â•‘  âœ… Ð”Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°                                                â•‘
â•‘  âœ… Ð”Ð½ÐµÐ²Ð½Ñ‹Ðµ Ð½Ð°Ð³Ñ€Ð°Ð´Ñ‹ Ð¸ ÐºÐ²ÐµÑÑ‚Ñ‹                                               â•‘
â•‘  âœ… ÐŸÐ’ÐŸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° (Ð±Ð¾Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¼Ð¸)                                       â•‘
â•‘  âœ… Ð“Ð¸Ð»ÑŒÐ´Ð¸Ð¸ Ð¸ Ñ€ÐµÐ¹Ð´Ñ‹                                                        â•‘
â•‘  âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ‡Ð°Ñ‚Ð° Ð¸ Ñ‚Ð¾Ñ€Ð³Ð¾Ð²Ð»Ð¸                                                â•‘
â•‘  âœ… ÐœÐ°Ð³Ð°Ð·Ð¸Ð½ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð² Ð¸ ÑƒÑÐ»ÑƒÐ³                                              â•‘
â•‘  âœ… Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸Ð³Ñ€Ð¾ÐºÐ°                                          â•‘
â•‘  âœ… Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ€ÑƒÐ½ Ð¸ Ð·Ð°Ñ‡Ð°Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¹                                              â•‘
â•‘                                                                            â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âš™ï¸ Ð˜ÐœÐŸÐžÐ Ð¢Ð« Ð˜ ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜ ÐžÐšÐ Ð£Ð–Ð•ÐÐ˜Ð¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

import os
import sqlite3
import asyncio
import json
import random
import logging
import hashlib
import time
from datetime import datetime, timedelta
from typing import Optional, Dict, List, Tuple, Any, Callable
from functools import wraps
from collections import defaultdict
from enum import Enum, auto

from dotenv import load_dotenv

from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    User,
    Chat,
    Message,
    CallbackQuery,
    ReplyKeyboardMarkup,
    KeyboardButton,
)
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    ConversationHandler,
    MessageHandler,
    filters,
)
from telegram.error import TimedOut, BadRequest, Unauthorized

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ” Ð—ÐÐ“Ð Ð£Ð—ÐšÐ ÐŸÐ•Ð Ð•ÐœÐ•ÐÐÐ«Ð¥ ÐžÐšÐ Ð£Ð–Ð•ÐÐ˜Ð¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

load_dotenv()
BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise ValueError("âŒ BOT_TOKEN Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² .env Ñ„Ð°Ð¹Ð»Ðµ!")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§¾ Ð›ÐžÐ“Ð˜Ð ÐžÐ’ÐÐÐ˜Ð•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if not os.path.exists("logs"):
    os.makedirs("logs", exist_ok=True)

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
    handlers=[
        logging.FileHandler("logs/runequestrpg.log", encoding="utf-8"),
        logging.StreamHandler(),
    ],
)
logger = logging.getLogger("RuneQuestRPG")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§  Ð’Ð¡ÐŸÐžÐœÐžÐ“ÐÐ¢Ð•Ð›Ð¬ÐÐ«Ð• Ð­ÐÐ£ÐœÐ« Ð˜ ÐšÐžÐÐ¡Ð¢ÐÐÐ¢Ð«
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


class Rarity(Enum):
    COMMON = "ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹"
    UNCOMMON = "ÐÐµÐ¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹"
    RARE = "Ð ÐµÐ´ÐºÐ¸Ð¹"
    EPIC = "Ð­Ð¿Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹"
    LEGENDARY = "Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ð¹"
    MYTHIC = "ÐœÐ¸Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹"


class Element(Enum):
    PHYSICAL = "Ð¤Ð¸Ð·Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹"
    FIRE = "ÐžÐ³Ð¾Ð½ÑŒ"
    ICE = "Ð›Ñ‘Ð´"
    SHADOW = "Ð¢ÑŒÐ¼Ð°"
    HOLY = "Ð¡Ð²ÐµÑ‚"
    POISON = "Ð¯Ð´"
    ARCANE = "Ð¢Ð°Ð¹Ð½Ð°Ñ Ð¼Ð°Ð³Ð¸Ñ"


class RuneType(Enum):
    OFFENSIVE = "ÐÑ‚Ð°ÐºÑƒÑŽÑ‰Ð°Ñ"
    DEFENSIVE = "Ð—Ð°Ñ‰Ð¸Ñ‚Ð½Ð°Ñ"
    UTILITY = "Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ð°Ñ€Ð½Ð°Ñ"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ“Š Ð˜Ð“Ð ÐžÐ’Ð«Ð• ÐšÐžÐÐ¡Ð¢ÐÐÐ¢Ð«
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

MAX_LEVEL = 100
LEVEL_UP_BASE = 100
STATS_PER_LEVEL = {"health": 20, "mana": 15, "attack": 5, "defense": 2}
MAX_INVENTORY_SLOTS = 150
STARTING_HP_REGEN_PER_HOUR = 0.05
BATTLE_TIMEOUT = 300
DUNGEON_TIMEOUT = 900
PVP_TIMEOUT = 600

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸŽ­ ÐšÐ›ÐÐ¡Ð¡Ð« ÐŸÐ•Ð Ð¡ÐžÐÐÐ–Ð•Ð™
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CLASSES: Dict[str, Dict[str, Any]] = {
    "warrior": {
        "name": "Ð’Ð¾Ð¸Ð½",
        "emoji": "âš”ï¸",
        "description": "Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð¾ÐµÑ† Ð±Ð»Ð¸Ð¶Ð½ÐµÐ³Ð¾ Ð±Ð¾Ñ",
        "health": 120,
        "mana": 30,
        "attack": 15,
        "defense": 8,
        "crit_chance": 5,
        "starting_gold": 100,
        "spell_power": 0,
        "dodge_chance": 3,
        "element": Element.PHYSICAL.value,
    },
    "mage": {
        "name": "ÐœÐ°Ð³",
        "emoji": "ðŸ”¥",
        "description": "ÐœÐ°ÑÑ‚ÐµÑ€ Ñ€Ð°Ð·Ñ€ÑƒÑˆÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¼Ð°Ð³Ð¸Ð¸",
        "health": 70,
        "mana": 130,
        "attack": 8,
        "defense": 3,
        "crit_chance": 8,
        "starting_gold": 150,
        "spell_power": 25,
        "dodge_chance": 2,
        "element": Element.ARCANE.value,
    },
    "rogue": {
        "name": "Ð Ð°Ð·Ð±Ð¾Ð¹Ð½Ð¸Ðº",
        "emoji": "ðŸ—¡ï¸",
        "description": "Ð›Ð¾Ð²ÐºÐ¸Ð¹ Ð°ÑÑÐ°ÑÐ¸Ð½ Ñ Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¼ ÐºÑ€Ð¸Ñ‚Ð¾Ð¼",
        "health": 85,
        "mana": 50,
        "attack": 19,
        "defense": 5,
        "crit_chance": 22,
        "starting_gold": 130,
        "spell_power": 5,
        "dodge_chance": 12,
        "element": Element.SHADOW.value,
    },
    "paladin": {
        "name": "ÐŸÐ°Ð»Ð°Ð´Ð¸Ð½",
        "emoji": "â›ª",
        "description": "Ð¡Ð²ÑÑ‚Ð¾Ð¹ Ð²Ð¾Ð¸Ð½ ÑÐ¾ ÑÐ²ÐµÑ‚Ð»Ð¾Ð¹ Ð¼Ð°Ð³Ð¸ÐµÐ¹",
        "health": 140,
        "mana": 80,
        "attack": 13,
        "defense": 15,
        "crit_chance": 4,
        "starting_gold": 140,
        "spell_power": 12,
        "dodge_chance": 4,
        "element": Element.HOLY.value,
    },
    "ranger": {
        "name": "Ð ÐµÐ¹Ð½Ð´Ð¶ÐµÑ€",
        "emoji": "ðŸ¹",
        "description": "ÐœÐ°ÑÑ‚ÐµÑ€ Ð´Ð°Ð»ÑŒÐ½ÐµÐ³Ð¾ Ð±Ð¾Ñ Ð¸ Ð»Ð¾Ð²ÐºÐ¾ÑÑ‚Ð¸",
        "health": 95,
        "mana": 65,
        "attack": 17,
        "defense": 6,
        "crit_chance": 16,
        "starting_gold": 120,
        "spell_power": 8,
        "dodge_chance": 9,
        "element": Element.POISON.value,
    },
    "necromancer": {
        "name": "ÐÐµÐºÑ€Ð¾Ð¼Ð°Ð½Ñ‚",
        "emoji": "ðŸ’€",
        "description": "ÐŸÐ¾Ð²ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ ÑÐ¼ÐµÑ€Ñ‚Ð¸ Ð¸ Ñ‚ÑŒÐ¼Ñ‹",
        "health": 80,
        "mana": 135,
        "attack": 10,
        "defense": 4,
        "crit_chance": 7,
        "starting_gold": 160,
        "spell_power": 30,
        "dodge_chance": 3,
        "element": Element.SHADOW.value,
    },
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ‘¹ Ð’Ð ÐÐ“Ð˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ENEMIES: Dict[str, Dict[str, Any]] = {
    "goblin": {
        "name": "Ð“Ð¾Ð±Ð»Ð¸Ð½",
        "emoji": "ðŸ‘¹",
        "level": 1,
        "hp": 25,
        "damage": 5,
        "xp": 30,
        "gold": 10,
        "loot": ["copper_ore", "bone"],
        "boss": False,
        "element": Element.PHYSICAL.value,
    },
    "wolf": {
        "name": "Ð’Ð¾Ð»Ðº",
        "emoji": "ðŸº",
        "level": 2,
        "hp": 35,
        "damage": 8,
        "xp": 50,
        "gold": 15,
        "loot": ["copper_ore", "wolf_fang"],
        "boss": False,
        "element": Element.PHYSICAL.value,
    },
    "skeleton": {
        "name": "Ð¡ÐºÐµÐ»ÐµÑ‚",
        "emoji": "ðŸ’€",
        "level": 3,
        "hp": 40,
        "damage": 10,
        "xp": 70,
        "gold": 20,
        "loot": ["bone", "copper_ore"],
        "boss": False,
        "element": Element.SHADOW.value,
    },
    "orc": {
        "name": "ÐžÑ€Ðº",
        "emoji": "ðŸ‘º",
        "level": 4,
        "hp": 55,
        "damage": 13,
        "xp": 110,
        "gold": 35,
        "loot": ["iron_ore", "bone"],
        "boss": False,
        "element": Element.PHYSICAL.value,
    },
    "troll": {
        "name": "Ð¢Ñ€Ð¾Ð»Ð»ÑŒ",
        "emoji": "ðŸ—»",
        "level": 5,
        "hp": 75,
        "damage": 16,
        "xp": 160,
        "gold": 55,
        "loot": ["iron_ore", "troll_hide"],
        "boss": False,
        "element": Element.PHYSICAL.value,
    },
    "basilisk": {
        "name": "Ð’Ð°ÑÐ¸Ð»Ð¸ÑÐº",
        "emoji": "ðŸ",
        "level": 7,
        "hp": 90,
        "damage": 20,
        "xp": 230,
        "gold": 80,
        "loot": ["mithril_ore", "basilisk_scale"],
        "boss": False,
        "element": Element.POISON.value,
    },
    "ice_mage": {
        "name": "Ð›ÐµÐ´ÑÐ½Ð¾Ð¹ Ð¼Ð°Ð³",
        "emoji": "â„ï¸",
        "level": 8,
        "hp": 70,
        "damage": 23,
        "xp": 260,
        "gold": 110,
        "loot": ["mithril_ore", "ice_crystal"],
        "boss": False,
        "element": Element.ICE.value,
    },
    "demon": {
        "name": "Ð”ÐµÐ¼Ð¾Ð½",
        "emoji": "ðŸ˜ˆ",
        "level": 10,
        "hp": 110,
        "damage": 28,
        "xp": 380,
        "gold": 170,
        "loot": ["demon_essence", "mithril_ore"],
        "boss": False,
        "element": Element.FIRE.value,
    },
    "vampire": {
        "name": "Ð’Ð°Ð¼Ð¿Ð¸Ñ€",
        "emoji": "ðŸ§›",
        "level": 12,
        "hp": 100,
        "damage": 30,
        "xp": 420,
        "gold": 190,
        "loot": ["blood_crystal", "demon_essence"],
        "boss": False,
        "element": Element.SHADOW.value,
    },
    "dragon_boss": {
        "name": "Ð”Ñ€ÐµÐ²Ð½Ð¸Ð¹ Ð”Ñ€Ð°ÐºÐ¾Ð½",
        "emoji": "ðŸ‰",
        "level": 15,
        "hp": 280,
        "damage": 48,
        "xp": 1600,
        "gold": 550,
        "loot": ["dragon_scale", "dragon_heart"],
        "boss": True,
        "element": Element.FIRE.value,
    },
    "lich_boss": {
        "name": "Ð›Ð¸Ñ‡",
        "emoji": "â˜ ï¸",
        "level": 18,
        "hp": 320,
        "damage": 52,
        "xp": 2100,
        "gold": 820,
        "loot": ["lich_stone", "soul_essence"],
        "boss": True,
        "element": Element.SHADOW.value,
    },
    "demon_lord": {
        "name": "Ð”ÐµÐ¼Ð¾Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð›Ð¾Ñ€Ð´",
        "emoji": "ðŸ‘¹",
        "level": 22,
        "hp": 420,
        "damage": 65,
        "xp": 3200,
        "gold": 1300,
        "loot": ["lord_essence", "ancient_gem"],
        "boss": True,
        "element": Element.FIRE.value,
    },
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ—¡ï¸ ÐžÐ Ð£Ð–Ð˜Ð•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

WEAPONS: Dict[str, Dict[str, Any]] = {
    "iron_sword": {
        "name": "Ð–ÐµÐ»ÐµÐ·Ð½Ñ‹Ð¹ Ð¼ÐµÑ‡",
        "emoji": "âš”ï¸",
        "attack": 10,
        "price": 100,
        "level": 1,
        "crit": 0,
        "rarity": Rarity.COMMON.value,
        "element": Element.PHYSICAL.value,
    },
    "steel_sword": {
        "name": "Ð¡Ñ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼ÐµÑ‡",
        "emoji": "âš”ï¸",
        "attack": 20,
        "price": 500,
        "level": 5,
        "crit": 2,
        "rarity": Rarity.UNCOMMON.value,
        "element": Element.PHYSICAL.value,
    },
    "mithril_sword": {
        "name": "ÐœÐ¸Ñ„Ñ€Ð¸Ð»Ð¾Ð²Ñ‹Ð¹ Ð¼ÐµÑ‡",
        "emoji": "âš”ï¸",
        "attack": 35,
        "price": 2000,
        "level": 15,
        "crit": 5,
        "rarity": Rarity.RARE.value,
        "element": Element.PHYSICAL.value,
    },
    "legendary_sword": {
        "name": "Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñ‹Ð¹ ÐºÐ»Ð¸Ð½Ð¾Ðº",
        "emoji": "âš”ï¸",
        "attack": 60,
        "price": 5000,
        "level": 30,
        "crit": 15,
        "rarity": Rarity.LEGENDARY.value,
        "element": Element.PHYSICAL.value,
    },
    "fire_staff": {
        "name": "ÐŸÐ¾ÑÐ¾Ñ… Ð¾Ð³Ð½Ñ",
        "emoji": "ðŸ”¥",
        "attack": 16,
        "price": 160,
        "level": 2,
        "crit": 3,
        "rarity": Rarity.UNCOMMON.value,
        "element": Element.FIRE.value,
    },
    "ice_staff": {
        "name": "Ð›ÐµÐ´ÑÐ½Ð¾Ð¹ Ð¿Ð¾ÑÐ¾Ñ…",
        "emoji": "â„ï¸",
        "attack": 19,
        "price": 320,
        "level": 5,
        "crit": 4,
        "rarity": Rarity.RARE.value,
        "element": Element.ICE.value,
    },
    "shadow_dagger": {
        "name": "ÐšÐ¸Ð½Ð¶Ð°Ð» Ð¢ÐµÐ½Ð¸",
        "emoji": "ðŸ—¡ï¸",
        "attack": 14,
        "price": 120,
        "level": 1,
        "crit": 12,
        "rarity": Rarity.UNCOMMON.value,
        "element": Element.SHADOW.value,
    },
    "holy_mace": {
        "name": "Ð¡Ð²ÑÑ‚Ð°Ñ Ð±ÑƒÐ»Ð°Ð²Ð°",
        "emoji": "ðŸ”¨",
        "attack": 17,
        "price": 230,
        "level": 3,
        "crit": 1,
        "rarity": Rarity.UNCOMMON.value,
        "element": Element.HOLY.value,
    },
    "long_bow": {
        "name": "Ð”Ð»Ð¸Ð½Ð½Ñ‹Ð¹ Ð»ÑƒÐº",
        "emoji": "ðŸ¹",
        "attack": 19,
        "price": 260,
        "level": 4,
        "crit": 9,
        "rarity": Rarity.UNCOMMON.value,
        "element": Element.PHYSICAL.value,
    },
    "death_scythe": {
        "name": "ÐšÐ¾ÑÐ° ÑÐ¼ÐµÑ€Ñ‚Ð¸",
        "emoji": "ðŸ”ª",
        "attack": 52,
        "price": 3200,
        "level": 20,
        "crit": 13,
        "rarity": Rarity.EPIC.value,
        "element": Element.SHADOW.value,
    },
    "arcane_orb": {
        "name": "Ð¡Ñ„ÐµÑ€Ð° Ñ‚Ð°Ð¹Ð½Ð¾Ð¹ Ð¼Ð°Ð³Ð¸Ð¸",
        "emoji": "ðŸŒ€",
        "attack": 28,
        "price": 1200,
        "level": 12,
        "crit": 6,
        "rarity": Rarity.RARE.value,
        "element": Element.ARCANE.value,
    },
    "dragon_spear": {
        "name": "Ð”Ñ€Ð°ÐºÐ¾Ð½Ð¸Ð¹ ÐºÐ¾Ð¿ÑŒÑ‘",
        "emoji": "ðŸ—¡ï¸",
        "attack": 44,
        "price": 2600,
        "level": 18,
        "crit": 10,
        "rarity": Rarity.EPIC.value,
        "element": Element.FIRE.value,
    },
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ›¡ï¸ Ð‘Ð ÐžÐÐ¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ARMOR: Dict[str, Dict[str, Any]] = {
    "iron_armor": {
        "name": "Ð–ÐµÐ»ÐµÐ·Ð½Ð°Ñ Ð±Ñ€Ð¾Ð½Ñ",
        "emoji": "ðŸ›¡ï¸",
        "defense": 8,
        "health": 20,
        "price": 150,
        "level": 1,
        "rarity": Rarity.COMMON.value,
    },
    "steel_armor": {
        "name": "Ð¡Ñ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð±Ñ€Ð¾Ð½Ñ",
        "emoji": "ðŸ›¡ï¸",
        "defense": 16,
        "health": 45,
        "price": 650,
        "level": 6,
        "rarity": Rarity.UNCOMMON.value,
    },
    "mithril_armor": {
        "name": "ÐœÐ¸Ñ„Ñ€Ð¸Ð»Ð¾Ð²Ð°Ñ Ð±Ñ€Ð¾Ð½Ñ",
        "emoji": "ðŸ›¡ï¸",
        "defense": 27,
        "health": 90,
        "price": 2600,
        "level": 16,
        "rarity": Rarity.RARE.value,
    },
    "leather_armor": {
        "name": "ÐšÐ¾Ð¶Ð°Ð½Ð°Ñ Ð±Ñ€Ð¾Ð½Ñ",
        "emoji": "ðŸ§¥",
        "defense": 6,
        "health": 18,
        "price": 110,
        "level": 1,
        "rarity": Rarity.COMMON.value,
    },
    "plate_armor": {
        "name": "ÐŸÐ»Ð°ÑÑ‚Ð¸Ð½Ñ‡Ð°Ñ‚Ð°Ñ Ð±Ñ€Ð¾Ð½Ñ",
        "emoji": "ðŸ›¡ï¸",
        "defense": 22,
        "health": 70,
        "price": 900,
        "level": 9,
        "rarity": Rarity.UNCOMMON.value,
    },
    "mage_robes": {
        "name": "ÐœÐ°Ð½Ñ‚Ð¸Ñ Ð¼Ð°Ð³Ð°",
        "emoji": "ðŸ‘—",
        "defense": 4,
        "health": 26,
        "price": 210,
        "level": 2,
        "rarity": Rarity.UNCOMMON.value,
    },
    "ranger_armor": {
        "name": "Ð‘Ñ€Ð¾Ð½Ñ Ñ€ÐµÐ¹Ð½Ð´Ð¶ÐµÑ€Ð°",
        "emoji": "ðŸ§¤",
        "defense": 11,
        "health": 32,
        "price": 320,
        "level": 3,
        "rarity": Rarity.UNCOMMON.value,
    },
    "holy_armor": {
        "name": "Ð¡Ð²ÑÑ‚Ð°Ñ Ð±Ñ€Ð¾Ð½Ñ",
        "emoji": "âœ¨",
        "defense": 19,
        "health": 75,
        "price": 1250,
        "level": 11,
        "rarity": Rarity.RARE.value,
    },
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ“¦ ÐœÐÐ¢Ð•Ð Ð˜ÐÐ›Ð«
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

MATERIALS: Dict[str, Dict[str, Any]] = {
    "copper_ore": {"name": "ÐœÐµÐ´Ð½Ð°Ñ Ñ€ÑƒÐ´Ð°", "emoji": "ðŸª¨", "value": 10},
    "iron_ore": {"name": "Ð–ÐµÐ»ÐµÐ·Ð½Ð°Ñ Ñ€ÑƒÐ´Ð°", "emoji": "ðŸª¨", "value": 20},
    "mithril_ore": {"name": "ÐœÐ¸Ñ„Ñ€Ð¸Ð»Ð¾Ð²Ð°Ñ Ñ€ÑƒÐ´Ð°", "emoji": "âœ¨", "value": 50},
    "bone": {"name": "ÐšÐ¾ÑÑ‚ÑŒ", "emoji": "ðŸ¦´", "value": 15},
    "wolf_fang": {"name": "ÐšÐ»Ñ‹Ðº Ð²Ð¾Ð»ÐºÐ°", "emoji": "ðŸº", "value": 25},
    "troll_hide": {"name": "Ð¨ÐºÑƒÑ€Ð° Ñ‚Ñ€Ð¾Ð»Ð»Ñ", "emoji": "ðŸªµ", "value": 30},
    "basilisk_scale": {"name": "Ð§ÐµÑˆÑƒÑ Ð²Ð°ÑÐ¸Ð»Ð¸ÑÐºÐ°", "emoji": "ðŸ", "value": 40},
    "ice_crystal": {"name": "Ð›ÐµÐ´ÑÐ½Ð¾Ð¹ ÐºÑ€Ð¸ÑÑ‚Ð°Ð»Ð»", "emoji": "â„ï¸", "value": 60},
    "demon_essence": {"name": "Ð¡ÑƒÑ‰Ð½Ð¾ÑÑ‚ÑŒ Ð´ÐµÐ¼Ð¾Ð½Ð°", "emoji": "ðŸ˜ˆ", "value": 100},
    "dragon_scale": {"name": "Ð§ÐµÑˆÑƒÑ Ð´Ñ€Ð°ÐºÐ¾Ð½Ð°", "emoji": "ðŸ‰", "value": 200},
    "dragon_heart": {"name": "Ð¡ÐµÑ€Ð´Ñ†Ðµ Ð´Ñ€Ð°ÐºÐ¾Ð½Ð°", "emoji": "â¤ï¸", "value": 300},
    "blood_crystal": {"name": "ÐšÑ€Ð¾Ð²Ð°Ð²Ñ‹Ð¹ ÐºÑ€Ð¸ÑÑ‚Ð°Ð»Ð»", "emoji": "ðŸ©¸", "value": 80},
    "soul_essence": {"name": "Ð¡ÑƒÑ‰Ð½Ð¾ÑÑ‚ÑŒ Ð´ÑƒÑˆÐ¸", "emoji": "ðŸ‘»", "value": 120},
    "lich_stone": {"name": "ÐšÐ°Ð¼ÐµÐ½ÑŒ Ð›Ð¸Ñ‡Ð°", "emoji": "ðŸŸ£", "value": 150},
    "ancient_gem": {"name": "Ð”Ñ€ÐµÐ²Ð½Ð¸Ð¹ ÑÐ°Ð¼Ð¾Ñ†Ð²ÐµÑ‚", "emoji": "ðŸ’Ž", "value": 250},
    "lord_essence": {"name": "Ð¡ÑƒÑ‰Ð½Ð¾ÑÑ‚ÑŒ Ð»Ð¾Ñ€Ð´Ð°", "emoji": "ðŸ”®", "value": 300},
    "copper_bar": {"name": "ÐœÐµÐ´Ð½Ñ‹Ð¹ ÑÐ»Ð¸Ñ‚Ð¾Ðº", "emoji": "ðŸ“¦", "value": 30},
    "iron_bar": {"name": "Ð–ÐµÐ»ÐµÐ·Ð½Ñ‹Ð¹ ÑÐ»Ð¸Ñ‚Ð¾Ðº", "emoji": "ðŸ“¦", "value": 60},
    "mithril_bar": {"name": "ÐœÐ¸Ñ„Ñ€Ð¸Ð»Ð¾Ð²Ñ‹Ð¹ ÑÐ»Ð¸Ñ‚Ð¾Ðº", "emoji": "ðŸ“¦", "value": 150},
    "rune_fragment": {"name": "Ð¤Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚ Ñ€ÑƒÐ½Ñ‹", "emoji": "ðŸ”¹", "value": 70},
    "rune_core": {"name": "Ð¯Ð´Ñ€Ð¾ Ñ€ÑƒÐ½Ñ‹", "emoji": "ðŸ”·", "value": 180},
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ”® Ð Ð£ÐÐ«
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

RUNES: Dict[str, Dict[str, Any]] = {
    "rune_of_power": {
        "name": "Ð ÑƒÐ½Ð° ÑÐ¸Ð»Ñ‹",
        "emoji": "ðŸ’¥",
        "type": RuneType.OFFENSIVE.value,
        "attack_bonus": 10,
        "defense_bonus": 0,
        "crit_bonus": 5,
        "price": 800,
    },
    "rune_of_protection": {
        "name": "Ð ÑƒÐ½Ð° Ð·Ð°Ñ‰Ð¸Ñ‚Ñ‹",
        "emoji": "ðŸ›¡ï¸",
        "type": RuneType.DEFENSIVE.value,
        "attack_bonus": 0,
        "defense_bonus": 12,
        "crit_bonus": 0,
        "price": 900,
    },
    "rune_of_focus": {
        "name": "Ð ÑƒÐ½Ð° ÑÐ¾ÑÑ€ÐµÐ´Ð¾Ñ‚Ð¾Ñ‡ÐµÐ½Ð¸Ñ",
        "emoji": "â™»ï¸",
        "type": RuneType.UTILITY.value,
        "attack_bonus": 5,
        "defense_bonus": 5,
        "crit_bonus": 3,
        "price": 700,
    },
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ§ª Ð Ð•Ð¦Ð•ÐŸÐ¢Ð« ÐšÐ ÐÐ¤Ð¢Ð
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CRAFTING_RECIPES: Dict[str, Dict[str, Any]] = {
    "copper_bar": {
        "name": "ÐœÐµÐ´Ð½Ñ‹Ð¹ ÑÐ»Ð¸Ñ‚Ð¾Ðº",
        "emoji": "ðŸ”¨",
        "materials": {"copper_ore": 5},
        "gold": 20,
        "level": 1,
        "result": "copper_bar",
    },
    "iron_bar": {
        "name": "Ð–ÐµÐ»ÐµÐ·Ð½Ñ‹Ð¹ ÑÐ»Ð¸Ñ‚Ð¾Ðº",
        "emoji": "ðŸ”¨",
        "materials": {"iron_ore": 5},
        "gold": 55,
        "level": 3,
        "result": "iron_bar",
    },
    "mithril_bar": {
        "name": "ÐœÐ¸Ñ„Ñ€Ð¸Ð»Ð¾Ð²Ñ‹Ð¹ ÑÐ»Ð¸Ñ‚Ð¾Ðº",
        "emoji": "ðŸ”¨",
        "materials": {"mithril_ore": 3, "ice_crystal": 1},
        "gold": 210,
        "level": 10,
        "result": "mithril_bar",
    },
    "health_potion": {
        "name": "Ð—ÐµÐ»ÑŒÐµ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ",
        "emoji": "ðŸ§ª",
        "materials": {"bone": 2, "copper_ore": 1},
        "gold": 35,
        "level": 1,
        "result": "health_potion",
    },
    "mana_potion": {
        "name": "Ð—ÐµÐ»ÑŒÐµ Ð¼Ð°Ð½Ñ‹",
        "emoji": "ðŸ§ª",
        "materials": {"ice_crystal": 1},
        "gold": 85,
        "level": 5,
        "result": "mana_potion",
    },
    "strength_potion": {
        "name": "Ð—ÐµÐ»ÑŒÐµ ÑÐ¸Ð»Ñ‹",
        "emoji": "ðŸ’ª",
        "materials": {"troll_hide": 1, "wolf_fang": 2},
        "gold": 110,
        "level": 7,
        "result": "strength_potion",
    },
    "iron_sword": {
        "name": "Ð–ÐµÐ»ÐµÐ·Ð½Ñ‹Ð¹ Ð¼ÐµÑ‡",
        "emoji": "âš”ï¸",
        "materials": {"iron_ore": 10, "copper_bar": 2},
        "gold": 210,
        "level": 5,
        "result": "iron_sword",
    },
    "steel_sword": {
        "name": "Ð¡Ñ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¼ÐµÑ‡",
        "emoji": "âš”ï¸",
        "materials": {"iron_bar": 5, "mithril_ore": 2},
        "gold": 520,
        "level": 10,
        "result": "steel_sword",
    },
    "iron_armor": {
        "name": "Ð–ÐµÐ»ÐµÐ·Ð½Ð°Ñ Ð±Ñ€Ð¾Ð½Ñ",
        "emoji": "ðŸ›¡ï¸",
        "materials": {"iron_ore": 15, "troll_hide": 3},
        "gold": 330,
        "level": 5,
        "result": "iron_armor",
    },
    "steel_armor": {
        "name": "Ð¡Ñ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð±Ñ€Ð¾Ð½Ñ",
        "emoji": "ðŸ›¡ï¸",
        "materials": {"iron_bar": 8, "mithril_ore": 3},
        "gold": 820,
        "level": 12,
        "result": "steel_armor",
    },
    "rune_fragment": {
        "name": "Ð¤Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚ Ñ€ÑƒÐ½Ñ‹",
        "emoji": "ðŸ”¹",
        "materials": {"blood_crystal": 1, "soul_essence": 1},
        "gold": 160,
        "level": 10,
        "result": "rune_fragment",
    },
    "rune_core": {
        "name": "Ð¯Ð´Ñ€Ð¾ Ñ€ÑƒÐ½Ñ‹",
        "emoji": "ðŸ”·",
        "materials": {"rune_fragment": 3, "ancient_gem": 1},
        "gold": 420,
        "level": 16,
        "result": "rune_core",
    },
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ¾ ÐŸÐ˜Ð¢ÐžÐœÐ¦Ð«
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PETS: Dict[str, Dict[str, Any]] = {
    "wolf": {
        "name": "Ð’Ð¾Ð»Ðº",
        "emoji": "ðŸº",
        "attack_bonus": 10,
        "defense_bonus": 0,
        "xp_bonus": 1.1,
        "price": 500,
        "level": 1,
    },
    "phoenix": {
        "name": "Ð¤ÐµÐ½Ð¸ÐºÑ",
        "emoji": "ðŸ”¥",
        "attack_bonus": 20,
        "defense_bonus": 5,
        "xp_bonus": 1.4,
        "price": 2000,
        "level": 10,
    },
    "dragon": {
        "name": "Ð”Ñ€Ð°ÐºÐ¾Ð½",
        "emoji": "ðŸ‰",
        "attack_bonus": 25,
        "defense_bonus": 10,
        "xp_bonus": 1.5,
        "price": 3200,
        "level": 15,
    },
    "shadow": {
        "name": "Ð¢ÐµÐ½ÑŒ",
        "emoji": "âš«",
        "attack_bonus": 15,
        "defense_bonus": 2,
        "xp_bonus": 1.3,
        "price": 1100,
        "level": 5,
    },
    "bear": {
        "name": "ÐœÐµÐ´Ð²ÐµÐ´ÑŒ",
        "emoji": "ðŸ»",
        "attack_bonus": 18,
        "defense_bonus": 8,
        "xp_bonus": 1.2,
        "price": 1500,
        "level": 8,
    },
    "demon": {
        "name": "ÐœÐ°Ð»Ñ‹Ð¹ Ð´ÐµÐ¼Ð¾Ð½",
        "emoji": "ðŸ˜ˆ",
        "attack_bonus": 32,
        "defense_bonus": 4,
        "xp_bonus": 1.6,
        "price": 5200,
        "level": 20,
    },
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸžï¸ Ð›ÐžÐšÐÐ¦Ð˜Ð˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

LOCATIONS: Dict[str, Dict[str, Any]] = {
    "dark_forest": {
        "name": "Ð¢Ñ‘Ð¼Ð½Ñ‹Ð¹ Ð»ÐµÑ",
        "emoji": "ðŸŒ²",
        "min_level": 1,
        "max_level": 10,
        "description": "Ð“ÑƒÑÑ‚Ð¾Ð¹ Ð»ÐµÑ Ñ Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¼Ð¸ Ñ‚Ð²Ð°Ñ€ÑÐ¼Ð¸",
        "enemies": ["goblin", "wolf", "skeleton"],
    },
    "mountain_cave": {
        "name": "Ð“Ð¾Ñ€Ð½Ñ‹Ðµ Ð¿ÐµÑ‰ÐµÑ€Ñ‹",
        "emoji": "â›°ï¸",
        "min_level": 10,
        "max_level": 25,
        "description": "Ð¥Ð¾Ð»Ð¾Ð´Ð½Ñ‹Ðµ Ð¿ÐµÑ‰ÐµÑ€Ñ‹ Ñ Ñ‚Ð²Ð°Ñ€ÑÐ¼Ð¸ Ð³Ð»ÑƒÐ±Ð¸Ð½",
        "enemies": ["troll", "basilisk", "ice_mage"],
    },
    "castle_ruins": {
        "name": "Ð ÑƒÐ¸Ð½Ñ‹ Ð·Ð°Ð¼ÐºÐ°",
        "emoji": "ðŸšï¸",
        "min_level": 25,
        "max_level": 45,
        "description": "Ð”Ñ€ÐµÐ²Ð½Ð¸Ðµ Ñ€ÑƒÐ¸Ð½Ñ‹, Ð½Ð°ÑÐµÐ»Ñ‘Ð½Ð½Ñ‹Ðµ Ð½ÐµÐ¶Ð¸Ñ‚ÑŒÑŽ",
        "enemies": ["demon", "skeleton", "orc"],
    },
    "volcano": {
        "name": "Ð’ÑƒÐ»ÐºÐ°Ð½",
        "emoji": "ðŸŒ‹",
        "min_level": 45,
        "max_level": 65,
        "description": "ÐžÐ±Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð³Ð½ÐµÐ½Ð½Ñ‹Ñ… Ð¼Ð¾Ð½ÑÑ‚Ñ€Ð¾Ð²",
        "enemies": ["demon", "dragon_boss", "basilisk"],
    },
    "demon_lair": {
        "name": "Ð›Ð¾Ð³Ð¾Ð²Ð¾ Ð´ÐµÐ¼Ð¾Ð½Ð¾Ð²",
        "emoji": "ðŸ‘¹",
        "min_level": 65,
        "max_level": 90,
        "description": "ÐÐ´ÑÐºÐ¾Ðµ Ð»Ð¾Ð³Ð¾Ð²Ð¾ Ð´Ñ€ÐµÐ²Ð½Ð¸Ñ… Ð´ÐµÐ¼Ð¾Ð½Ð¾Ð²",
        "enemies": ["demon", "vampire", "demon_lord"],
    },
    "frozen_peak": {
        "name": "ÐœÑ‘Ñ€Ð·Ð»Ñ‹Ð¹ Ð¿Ð¸Ðº",
        "emoji": "â„ï¸",
        "min_level": 20,
        "max_level": 40,
        "description": "Ð›ÐµÐ´ÑÐ½Ñ‹Ðµ Ð²ÐµÑ€ÑˆÐ¸Ð½Ñ‹ Ñ Ð¼Ð°Ð³Ð°Ð¼Ð¸ Ð¸ Ñ‡ÑƒÐ´Ð¸Ñ‰Ð°Ð¼Ð¸",
        "enemies": ["ice_mage", "basilisk", "wolf"],
    },
    "shadow_valley": {
        "name": "Ð”Ð¾Ð»Ð¸Ð½Ð° Ñ‚ÐµÐ½ÐµÐ¹",
        "emoji": "ðŸŒ‘",
        "min_level": 30,
        "max_level": 60,
        "description": "ÐœÑ€Ð°Ñ‡Ð½Ð°Ñ Ð´Ð¾Ð»Ð¸Ð½Ð°, Ð³Ð´Ðµ Ñ†Ð°Ñ€Ð¸Ñ‚ Ð²ÐµÑ‡Ð½Ð°Ñ Ñ‚ÑŒÐ¼Ð°",
        "enemies": ["vampire", "skeleton", "lich_boss"],
    },
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ† Ð”ÐžÐ¡Ð¢Ð˜Ð–Ð•ÐÐ˜Ð¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ACHIEVEMENTS: Dict[str, Dict[str, Any]] = {
    "first_blood": {
        "name": "ÐŸÐµÑ€Ð²Ð°Ñ ÐºÑ€Ð¾Ð²ÑŒ",
        "description": "ÐŸÐ¾Ð±ÐµÐ´Ð¸Ñ‚ÑŒ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð²Ñ€Ð°Ð³Ð°",
        "emoji": "âš”ï¸",
        "reward_gold": 100,
        "reward_xp": 50,
    },
    "level_10": {
        "name": "ÐÐ¾Ð²Ð¸Ñ‡Ð¾Ðº",
        "description": "Ð”Ð¾ÑÑ‚Ð¸Ñ‡ÑŒ 10 ÑƒÑ€Ð¾Ð²Ð½Ñ",
        "emoji": "â­",
        "reward_gold": 500,
        "reward_xp": 500,
    },
    "level_25": {
        "name": "ÐžÐ¿Ñ‹Ñ‚Ð½Ñ‹Ð¹",
        "description": "Ð”Ð¾ÑÑ‚Ð¸Ñ‡ÑŒ 25 ÑƒÑ€Ð¾Ð²Ð½Ñ",
        "emoji": "â­â­",
        "reward_gold": 1600,
        "reward_xp": 2200,
    },
    "level_50": {
        "name": "Ð’ÐµÑ‚ÐµÑ€Ð°Ð½",
        "description": "Ð”Ð¾ÑÑ‚Ð¸Ñ‡ÑŒ 50 ÑƒÑ€Ð¾Ð²Ð½Ñ",
        "emoji": "â­â­â­",
        "reward_gold": 5200,
        "reward_xp": 10200,
    },
    "collector": {
        "name": "ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¾Ð½ÐµÑ€",
        "description": "Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ 100 Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð¾Ð²",
        "emoji": "ðŸŽ",
        "reward_gold": 2600,
        "reward_xp": 1200,
    },
    "rich": {
        "name": "Ð‘Ð¾Ð³Ð°Ñ‡",
        "description": "ÐÐ°ÐºÐ¾Ð¿Ð¸Ñ‚ÑŒ 100000 Ð·Ð¾Ð»Ð¾Ñ‚Ð°",
        "emoji": "ðŸ’°",
        "reward_gold": 11000,
        "reward_xp": 5200,
    },
    "dungeon_master": {
        "name": "ÐŸÐ¾ÐºÐ¾Ñ€Ð¸Ñ‚ÐµÐ»ÑŒ Ð¿Ð¾Ð´Ð·ÐµÐ¼ÐµÐ»Ð¸Ð¹",
        "description": "Ð”Ð¾ÑÑ‚Ð¸Ñ‡ÑŒ 50 ÑÑ‚Ð°Ð¶Ð°",
        "emoji": "ðŸ†",
        "reward_gold": 5500,
        "reward_xp": 5200,
    },
    "boss_killer": {
        "name": "Ð˜ÑÑ‚Ñ€ÐµÐ±Ð¸Ñ‚ÐµÐ»ÑŒ Ð±Ð¾ÑÑÐ¾Ð²",
        "description": "Ð£Ð±Ð¸Ñ‚ÑŒ 30 Ð±Ð¾ÑÑÐ¾Ð²",
        "emoji": "ðŸ‘¹",
        "reward_gold": 4200,
        "reward_xp": 3200,
    },
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ’¾ Ð‘ÐÐ—Ð Ð”ÐÐÐÐ«Ð¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


def get_db(chat_id: int = None) -> sqlite3.Connection:
    db_name = "runequestrpg.db"
    conn = sqlite3.connect(db_name, timeout=30, check_same_thread=False)
    conn.row_factory = sqlite3.Row
    conn.execute("PRAGMA journal_mode=WAL")
    return conn


def safe_db_execute(func: Callable) -> Callable:
    @wraps(func)
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except sqlite3.IntegrityError as e:
            logger.error(f"âŒ Ð‘Ð” Integrity Error: {e}")
            return None
        except sqlite3.OperationalError as e:
            logger.error(f"âŒ Ð‘Ð” Operational Error: {e}")
            return None
        except Exception as e:
            logger.error(f"âŒ Ð‘Ð” Error: {e}")
            return None

    return wrapper


@safe_db_execute
def init_database():
    conn = get_db()
    c = conn.cursor()

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS players (
            user_id INTEGER PRIMARY KEY,
            chat_id INTEGER,
            username TEXT,
            class TEXT NOT NULL,
            level INTEGER DEFAULT 1,
            xp INTEGER DEFAULT 0,
            health INTEGER,
            max_health INTEGER,
            mana INTEGER,
            max_mana INTEGER,
            attack INTEGER,
            defense INTEGER,
            gold INTEGER DEFAULT 0,
            dungeon_rating INTEGER DEFAULT 0,
            dungeon_max_floor INTEGER DEFAULT 0,
            equipped_weapon TEXT,
            equipped_armor TEXT,
            equipped_rune TEXT,
            pet_id TEXT DEFAULT 'wolf',
            pet_level INTEGER DEFAULT 1,
            total_kills INTEGER DEFAULT 0,
            total_bosses_killed INTEGER DEFAULT 0,
            total_raids_completed INTEGER DEFAULT 0,
            total_damage_dealt INTEGER DEFAULT 0,
            total_damage_taken INTEGER DEFAULT 0,
            total_battles_won INTEGER DEFAULT 0,
            total_battles_lost INTEGER DEFAULT 0,
            pvp_wins INTEGER DEFAULT 0,
            pvp_losses INTEGER DEFAULT 0,
            craft_count INTEGER DEFAULT 0,
            last_daily_reward TIMESTAMP,
            last_heal TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS inventory (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            chat_id INTEGER,
            item_id TEXT NOT NULL,
            item_type TEXT,
            quantity INTEGER DEFAULT 1,
            equipped INTEGER DEFAULT 0,
            acquired_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(user_id) REFERENCES players(user_id),
            UNIQUE(user_id, item_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS battles (
            user_id INTEGER PRIMARY KEY,
            chat_id INTEGER,
            enemy_id TEXT NOT NULL,
            enemy_health INTEGER,
            enemy_max_health INTEGER,
            enemy_damage INTEGER,
            is_boss BOOLEAN DEFAULT 0,
            player_health INTEGER,
            player_max_health INTEGER,
            started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            rounds INTEGER DEFAULT 0,
            FOREIGN KEY(user_id) REFERENCES players(user_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS dungeon_runs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            chat_id INTEGER,
            floor_reached INTEGER,
            score INTEGER,
            enemies_killed INTEGER DEFAULT 0,
            bosses_killed INTEGER DEFAULT 0,
            rewards TEXT,
            duration_seconds INTEGER,
            completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(user_id) REFERENCES players(user_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS achievements (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            chat_id INTEGER,
            achievement_id TEXT NOT NULL,
            earned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(user_id) REFERENCES players(user_id),
            UNIQUE(user_id, achievement_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS daily_rewards (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            chat_id INTEGER,
            day_streak INTEGER DEFAULT 1,
            gold_reward INTEGER,
            xp_reward INTEGER,
            item_reward TEXT,
            claimed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(user_id) REFERENCES players(user_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS pvp_battles (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            attacker_id INTEGER NOT NULL,
            defender_id INTEGER NOT NULL,
            winner_id INTEGER NOT NULL,
            damage_dealt INTEGER,
            gold_reward INTEGER,
            xp_reward INTEGER,
            fought_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(attacker_id) REFERENCES players(user_id),
            FOREIGN KEY(defender_id) REFERENCES players(user_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS guilds (
            guild_id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE NOT NULL,
            leader_id INTEGER NOT NULL,
            description TEXT,
            level INTEGER DEFAULT 1,
            gold INTEGER DEFAULT 0,
            members_count INTEGER DEFAULT 1,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(leader_id) REFERENCES players(user_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS guild_members (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            guild_id INTEGER NOT NULL,
            user_id INTEGER NOT NULL,
            role TEXT DEFAULT 'member',
            joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(guild_id) REFERENCES guilds(guild_id),
            FOREIGN KEY(user_id) REFERENCES players(user_id),
            UNIQUE(guild_id, user_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS quests (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            chat_id INTEGER,
            quest_type TEXT NOT NULL,
            progress INTEGER DEFAULT 0,
            target INTEGER NOT NULL,
            gold_reward INTEGER,
            xp_reward INTEGER,
            status TEXT DEFAULT 'active',
            started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            completed_at TIMESTAMP,
            FOREIGN KEY(user_id) REFERENCES players(user_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS trades (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            seller_id INTEGER,
            buyer_id INTEGER,
            item_id TEXT NOT NULL,
            quantity INTEGER,
            price_per_item INTEGER,
            status TEXT DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            completed_at TIMESTAMP,
            FOREIGN KEY(seller_id) REFERENCES players(user_id),
            FOREIGN KEY(buyer_id) REFERENCES players(user_id)
        )
        """
    )

    c.execute(
        """
        CREATE TABLE IF NOT EXISTS battle_logs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            battle_type TEXT,
            opponent_id TEXT,
            damage_dealt INTEGER,
            damage_taken INTEGER,
            result TEXT,
            duration_seconds INTEGER,
            logged_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY(user_id) REFERENCES players(user_id)
        )
        """
    )

    c.execute("CREATE INDEX IF NOT EXISTS idx_user_id ON players(user_id)")
    c.execute("CREATE INDEX IF NOT EXISTS idx_level ON players(level)")
    c.execute(
        "CREATE INDEX IF NOT EXISTS idx_dungeon_rating ON players(dungeon_rating)"
    )
    c.execute(
        "CREATE INDEX IF NOT EXISTS idx_inventory_user ON inventory(user_id)"
    )
    c.execute("CREATE INDEX IF NOT EXISTS idx_battles_user ON battles(user_id)")
    c.execute(
        "CREATE INDEX IF NOT EXISTS idx_achievements_user ON achievements(user_id)"
    )

    conn.commit()
    conn.close()
    logger.info("âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… RuneQuestRPG Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ‘¤ Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð˜Ð“Ð ÐžÐšÐžÐ’
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


@safe_db_execute
def init_player(chat_id: int, user_id: int, user_name: str, player_class: str) -> bool:
    conn = get_db()
    c = conn.cursor()
    try:
        class_info = CLASSES.get(player_class, CLASSES["warrior"])
        c.execute(
            """
            INSERT INTO players (
                user_id, chat_id, username, class,
                level, xp, health, max_health, mana, max_mana,
                attack, defense, gold, pet_id
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """,
            (
                user_id,
                chat_id,
                (user_name or "")[:50],
                player_class,
                1,
                0,
                class_info["health"],
                class_info["health"],
                class_info["mana"],
                class_info["mana"],
                class_info["attack"],
                class_info["defense"],
                class_info["starting_gold"],
                "wolf",
            ),
        )
        c.execute(
            """
            INSERT INTO inventory (user_id, chat_id, item_id, item_type, quantity)
            VALUES (?, ?, ?, ?, ?)
            """,
            (user_id, chat_id, "health_potion", "potion", 3),
        )
        conn.commit()
        return True
    except sqlite3.IntegrityError:
        logger.warning(f"âš ï¸ Ð˜Ð³Ñ€Ð¾Ðº {user_id} ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚")
        return False
    finally:
        conn.close()


@safe_db_execute
def get_player(chat_id: int, user_id: int) -> Optional[Dict[str, Any]]:
    conn = get_db()
    c = conn.cursor()
    c.execute(
        "SELECT * FROM players WHERE user_id = ? AND chat_id = ?",
        (user_id, chat_id),
    )
    row = c.fetchone()
    conn.close()
    return dict(row) if row else None


@safe_db_execute
def player_exists(chat_id: int, user_id: int) -> bool:
    conn = get_db()
    c = conn.cursor()
    c.execute(
        "SELECT 1 FROM players WHERE user_id = ? AND chat_id = ?",
        (user_id, chat_id),
    )
    exists = c.fetchone() is not None
    conn.close()
    return exists


@safe_db_execute
def add_xp(chat_id: int, user_id: int, username: str, xp_amount: int) -> int:
    player = get_player(chat_id, user_id)
    if not player:
        return 0

    new_xp = player["xp"] + xp_amount
    current_level = player["level"]
    levels_up = 0

    while current_level < MAX_LEVEL:
        xp_needed = int(LEVEL_UP_BASE * (current_level ** 1.5))
        if new_xp >= xp_needed:
            new_xp -= xp_needed
            current_level += 1
            levels_up += 1
        else:
            break

    conn = get_db()
    c = conn.cursor()
    if levels_up > 0:
        new_health = player["max_health"] + STATS_PER_LEVEL["health"] * levels_up
        new_mana = player["max_mana"] + STATS_PER_LEVEL["mana"] * levels_up
        new_attack = player["attack"] + STATS_PER_LEVEL["attack"] * levels_up
        new_defense = player["defense"] + STATS_PER_LEVEL["defense"] * levels_up
        c.execute(
            """
            UPDATE players SET
                xp = ?, level = ?,
                max_health = ?, health = ?,
                max_mana = ?, mana = ?,
                attack = ?, defense = ?
            WHERE user_id = ? AND chat_id = ?
            """,
            (
                new_xp,
                current_level,
                new_health,
                new_health,
                new_mana,
                new_mana,
                new_attack,
                new_defense,
                user_id,
                chat_id,
            ),
        )
    else:
        c.execute(
            "UPDATE players SET xp = ? WHERE user_id = ? AND chat_id = ?",
            (new_xp, user_id, chat_id),
        )

    conn.commit()
    conn.close()
    return levels_up


@safe_db_execute
def add_gold(chat_id: int, user_id: int, amount: int):
    conn = get_db()
    c = conn.cursor()
    c.execute(
        "UPDATE players SET gold = gold + ? WHERE user_id = ? AND chat_id = ?",
        (amount, user_id, chat_id),
    )
    conn.commit()
    conn.close()


@safe_db_execute
def subtract_gold(chat_id: int, user_id: int, amount: int) -> bool:
    player = get_player(chat_id, user_id)
    if not player or player["gold"] < amount:
        return False
    conn = get_db()
    c = conn.cursor()
    c.execute(
        "UPDATE players SET gold = gold - ? WHERE user_id = ? AND chat_id = ?",
        (amount, user_id, chat_id),
    )
    conn.commit()
    conn.close()
    return True


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸŽ’ Ð˜ÐÐ’Ð•ÐÐ¢ÐÐ Ð¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


@safe_db_execute
def add_item(chat_id: int, user_id: int, item_id: str, quantity: int = 1):
    conn = get_db()
    c = conn.cursor()
    try:
        c.execute(
            """
            SELECT quantity FROM inventory
            WHERE user_id = ? AND chat_id = ? AND item_id = ?
            """,
            (user_id, chat_id, item_id),
        )
        row = c.fetchone()
        if row:
            c.execute(
                """
                UPDATE inventory
                SET quantity = quantity + ?
                WHERE user_id = ? AND chat_id = ? AND item_id = ?
                """,
                (quantity, user_id, chat_id, item_id),
            )
        else:
            if item_id in WEAPONS:
                item_type = "weapon"
            elif item_id in ARMOR:
                item_type = "armor"
            elif item_id in MATERIALS:
                item_type = "material"
            elif item_id in RUNES:
                item_type = "rune"
            else:
                item_type = "misc"
            c.execute(
                """
                INSERT INTO inventory (user_id, chat_id, item_id, item_type, quantity)
                VALUES (?, ?, ?, ?, ?)
                """,
                (user_id, chat_id, item_id, item_type, quantity),
            )
        conn.commit()
    finally:
        conn.close()


@safe_db_execute
def remove_item(chat_id: int, user_id: int, item_id: str, quantity: int = 1) -> bool:
    conn = get_db()
    c = conn.cursor()
    try:
        c.execute(
            """
            SELECT quantity FROM inventory
            WHERE user_id = ? AND chat_id = ? AND item_id = ?
            """,
            (user_id, chat_id, item_id),
        )
        row = c.fetchone()
        if not row or row["quantity"] < quantity:
            return False
        if row["quantity"] == quantity:
            c.execute(
                """
                DELETE FROM inventory
                WHERE user_id = ? AND chat_id = ? AND item_id = ?
                """,
                (user_id, chat_id, item_id),
            )
        else:
            c.execute(
                """
                UPDATE inventory
                SET quantity = quantity - ?
                WHERE user_id = ? AND chat_id = ? AND item_id = ?
                """,
                (quantity, user_id, chat_id, item_id),
            )
        conn.commit()
        return True
    finally:
        conn.close()


@safe_db_execute
def get_inventory(chat_id: int, user_id: int) -> List[Dict[str, Any]]:
    conn = get_db()
    c = conn.cursor()
    c.execute(
        """
        SELECT * FROM inventory
        WHERE user_id = ? AND chat_id = ?
        ORDER BY item_type, item_id
        """,
        (user_id, chat_id),
    )
    items = [dict(r) for r in c.fetchall()]
    conn.close()
    return items


@safe_db_execute
def get_material(chat_id: int, user_id: int, material_id: str) -> int:
    conn = get_db()
    c = conn.cursor()
    c.execute(
        """
        SELECT quantity FROM inventory
        WHERE user_id = ? AND chat_id = ? AND item_id = ?
        """,
        (user_id, chat_id, material_id),
    )
    row = c.fetchone()
    conn.close()
    return row["quantity"] if row else 0


@safe_db_execute
def get_materials(chat_id: int, user_id: int) -> Dict[str, int]:
    conn = get_db()
    c = conn.cursor()
    c.execute(
        """
        SELECT item_id, quantity FROM inventory
        WHERE user_id = ? AND chat_id = ? AND item_type = 'material'
        """,
        (user_id, chat_id),
    )
    materials = {row["item_id"]: row["quantity"] for row in c.fetchall()}
    conn.close()
    return materials


@safe_db_execute
def add_material(chat_id: int, user_id: int, material_id: str, quantity: int = 1):
    add_item(chat_id, user_id, material_id, quantity)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âš”ï¸ Ð‘ÐžÐ•Ð’ÐÐ¯ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


def calculate_elemental_modifier(attacker_element: str, defender_element: str) -> float:
    if attacker_element == Element.FIRE.value and defender_element == Element.ICE.value:
        return 1.25
    if attacker_element == Element.ICE.value and defender_element == Element.FIRE.value:
        return 0.75
    if attacker_element == Element.HOLY.value and defender_element == Element.SHADOW.value:
        return 1.3
    if attacker_element == Element.SHADOW.value and defender_element == Element.HOLY.value:
        return 0.8
    if attacker_element == Element.POISON.value and defender_element == Element.PHYSICAL.value:
        return 1.15
    return 1.0


def calculate_damage(
    attacker_attack: int,
    defender_defense: int,
    attacker_crit_chance: int = 5,
    spell_power: int = 0,
    attacker_element: Optional[str] = None,
    defender_element: Optional[str] = None,
    rune_attack_bonus: int = 0,
    rune_crit_bonus: int = 0,
) -> Tuple[int, bool]:
    base_damage = max(1, attacker_attack + rune_attack_bonus - defender_defense // 2)
    variation = random.uniform(0.85, 1.15)
    damage = int(base_damage * variation)
    if spell_power > 0:
        spell_damage = int(spell_power * random.uniform(0.8, 1.2))
        damage += spell_damage
    if attacker_element and defender_element:
        modifier = calculate_elemental_modifier(attacker_element, defender_element)
        damage = int(damage * modifier)
    crit_final_chance = max(0, attacker_crit_chance + rune_crit_bonus)
    is_crit = random.randint(1, 100) <= crit_final_chance
    if is_crit:
        damage = int(damage * 1.5)
    return max(1, damage), is_crit


@safe_db_execute
def start_battle(chat_id: int, user_id: int, location_id: Optional[str] = None):
    player = get_player(chat_id, user_id)
    if not player:
        return None
    if location_id and location_id in LOCATIONS:
        possible_enemies = LOCATIONS[location_id]["enemies"]
    else:
        possible_enemies = list(ENEMIES.keys())
    enemy_id = random.choice(possible_enemies)
    enemy_template = ENEMIES[enemy_id].copy()
    level_diff = max(1, player["level"] - enemy_template["level"])
    scale = 1.0 + level_diff * 0.12
    enemy_template["current_hp"] = int(enemy_template["hp"] * scale)
    enemy_template["scaled_damage"] = int(enemy_template["damage"] * scale)
    conn = get_db()
    c = conn.cursor()
    c.execute(
        """
        INSERT OR REPLACE INTO battles (
            user_id, chat_id, enemy_id, enemy_health, enemy_max_health,
            enemy_damage, is_boss, player_health, player_max_health
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        """,
        (
            user_id,
            chat_id,
            enemy_id,
            enemy_template["current_hp"],
            int(enemy_template["hp"] * scale),
            enemy_template["scaled_damage"],
            int(enemy_template.get("boss", False)),
            player["health"],
            player["max_health"],
        ),
    )
    conn.commit()
    conn.close()
    return {
        "enemy_id": enemy_id,
        "enemy_name": enemy_template["name"],
        "enemy_emoji": enemy_template["emoji"],
        "enemy_level": enemy_template["level"],
        "enemy_health": enemy_template["current_hp"],
        "enemy_max_health": int(enemy_template["hp"] * scale),
        "enemy_damage": enemy_template["scaled_damage"],
        "is_boss": enemy_template.get("boss", False),
    }


@safe_db_execute
def get_active_battle(chat_id: int, user_id: int) -> Optional[Dict[str, Any]]:
    conn = get_db()
    c = conn.cursor()
    c.execute(
        "SELECT * FROM battles WHERE user_id = ? AND chat_id = ?",
        (user_id, chat_id),
    )
    row = c.fetchone()
    conn.close()
    return dict(row) if row else None


@safe_db_execute
def end_battle(chat_id: int, user_id: int):
    conn = get_db()
    c = conn.cursor()
    c.execute(
        "DELETE FROM battles WHERE user_id = ? AND chat_id = ?",
        (user_id, chat_id),
    )
    conn.commit()
    conn.close()


@safe_db_execute
def perform_attack(chat_id: int, user_id: int) -> Dict[str, Any]:
    player = get_player(chat_id, user_id)
    battle = get_active_battle(chat_id, user_id)
    if not player or not battle:
        return {"success": False, "message": "âŒ Ð‘Ð¾Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"}

    class_info = CLASSES.get(player["class"], {})
    crit_chance = class_info.get("crit_chance", 5)
    spell_power = class_info.get("spell_power", 0)
    attacker_element = class_info.get("element", Element.PHYSICAL.value)
    enemy_element = ENEMIES[battle["enemy_id"]].get("element", Element.PHYSICAL.value)

    rune_attack_bonus = 0
    rune_crit_bonus = 0
    if player.get("equipped_rune"):
        rune = RUNES.get(player["equipped_rune"])
        if rune:
            rune_attack_bonus = rune.get("attack_bonus", 0)
            rune_crit_bonus = rune.get("crit_bonus", 0)

    damage, is_crit = calculate_damage(
        player["attack"],
        0,
        crit_chance,
        spell_power,
        attacker_element,
        enemy_element,
        rune_attack_bonus,
        rune_crit_bonus,
    )
    new_enemy_hp = battle["enemy_health"] - damage
    result: Dict[str, Any] = {
        "success": True,
        "damage": damage,
        "is_crit": is_crit,
        "enemy_hp": max(0, new_enemy_hp),
        "enemy_max_hp": battle["enemy_max_health"],
        "enemy_defeated": new_enemy_hp <= 0,
    }

    if new_enemy_hp <= 0:
        end_battle(chat_id, user_id)
        enemy = ENEMIES[battle["enemy_id"]]
        xp_gained = enemy["xp"]
        gold_gained = enemy["gold"]
        if player["pet_id"] in PETS:
            xp_gained = int(xp_gained * PETS[player["pet_id"]]["xp_bonus"])
        add_gold(chat_id, user_id, gold_gained)
        levels_up = add_xp(chat_id, user_id, player["username"], xp_gained)
        result["xp_gained"] = xp_gained
        result["gold_gained"] = gold_gained
        result["levels_up"] = levels_up
        if random.randint(1, 100) <= 40 and enemy.get("loot"):
            loot_item = random.choice(enemy["loot"])
            add_material(chat_id, user_id, loot_item)
            result["loot"] = loot_item
        conn = get_db()
        c = conn.cursor()
        c.execute(
            """
            UPDATE players SET
                total_kills = total_kills + 1,
                total_damage_dealt = total_damage_dealt + ?,
                total_battles_won = total_battles_won + 1
            WHERE user_id = ? AND chat_id = ?
            """,
            (damage, user_id, chat_id),
        )
        if enemy.get("boss"):
            c.execute(
                """
                UPDATE players SET total_bosses_killed = total_bosses_killed + 1
                WHERE user_id = ? AND chat_id = ?
                """,
                (user_id, chat_id),
            )
        c.execute(
            """
            INSERT INTO battle_logs (user_id, battle_type, opponent_id, damage_dealt, result)
            VALUES (?, 'monster', ?, ?, 'win')
            """,
            (user_id, battle["enemy_id"], damage),
        )
        conn.commit()
        conn.close()
    else:
        conn = get_db()
        c = conn.cursor()
        c.execute(
            """
            UPDATE battles SET enemy_health = ?
            WHERE user_id = ? AND chat_id = ?
            """,
            (new_enemy_hp, user_id, chat_id),
        )
        conn.commit()
        conn.close()

        enemy_damage, _ = calculate_damage(
            battle["enemy_damage"],
            player["defense"],
            attacker_crit_chance=5,
            spell_power=0,
            attacker_element=enemy_element,
            defender_element=attacker_element,
        )
        new_player_hp = player["health"] - enemy_damage
        result["enemy_attack"] = enemy_damage
        result["player_hp"] = max(0, new_player_hp)
        result["player_max_hp"] = player["max_health"]

        if new_player_hp <= 0:
            end_battle(chat_id, user_id)
            gold_lost = int(player["gold"] * 0.1)
            subtract_gold(chat_id, user_id, gold_lost)
            conn = get_db()
            c = conn.cursor()
            c.execute(
                """
                UPDATE players SET
                    health = max_health,
                    total_battles_lost = total_battles_lost + 1,
                    total_damage_taken = total_damage_taken + ?
                WHERE user_id = ? AND chat_id = ?
                """,
                (enemy_damage, user_id, chat_id),
            )
            c.execute(
                """
                INSERT INTO battle_logs (user_id, battle_type, opponent_id, damage_taken, result)
                VALUES (?, 'monster', ?, ?, 'lose')
                """,
                (user_id, battle["enemy_id"], enemy_damage),
            )
            conn.commit()
            conn.close()
            result["defeat"] = True
            result["gold_lost"] = gold_lost
        else:
            conn = get_db()
            c = conn.cursor()
            c.execute(
                """
                UPDATE players SET health = ?, total_damage_taken = total_damage_taken + ?
                WHERE user_id = ? AND chat_id = ?
                """,
                (new_player_hp, enemy_damage, user_id, chat_id),
            )
            conn.commit()
            conn.close()

    return result


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ”¨ ÐšÐ ÐÐ¤Ð¢Ð˜ÐÐ“
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


@safe_db_execute
def craft_item(chat_id: int, user_id: int, recipe_id: str) -> Dict[str, Any]:
    player = get_player(chat_id, user_id)
    recipe = CRAFTING_RECIPES.get(recipe_id)
    if not player or not recipe:
        return {"success": False, "message": "âŒ Ð ÐµÑ†ÐµÐ¿Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"}
    if player["level"] < recipe["level"]:
        return {
            "success": False,
            "message": f'âŒ Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ {recipe["level"]}',
        }
    if player["gold"] < recipe["gold"]:
        return {
            "success": False,
            "message": f'âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð·Ð¾Ð»Ð¾Ñ‚Ð° ({recipe["gold"]})',
        }

    for material, needed in recipe["materials"].items():
        have = get_material(chat_id, user_id, material)
        if have < needed:
            material_name = MATERIALS.get(material, {}).get("name", material)
            return {
                "success": False,
                "message": f"âŒ ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ {material_name}",
            }

    for material, needed in recipe["materials"].items():
        remove_item(chat_id, user_id, material, needed)
    subtract_gold(chat_id, user_id, recipe["gold"])
    add_item(chat_id, user_id, recipe["result"])

    conn = get_db()
    c = conn.cursor()
    c.execute(
        """
        UPDATE players SET craft_count = craft_count + 1
        WHERE user_id = ? AND chat_id = ?
        """,
        (user_id, chat_id),
    )
    conn.commit()
    conn.close()

    return {
        "success": True,
        "item": recipe["result"],
        "name": recipe["name"],
    }


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸ“Š Ð›Ð˜Ð”Ð•Ð Ð‘ÐžÐ Ð”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


@safe_db_execute
def get_leaderboard(chat_id: int, limit: int = 10) -> List[Dict[str, Any]]:
    conn = get_db()
    c = conn.cursor()
    c.execute(
        """
        SELECT username, level, dungeon_rating, gold, total_kills, total_bosses_killed
        FROM players
        WHERE chat_id = ?
        ORDER BY dungeon_rating DESC, level DESC, gold DESC
        LIMIT ?
        """,
        (chat_id, limit),
    )
    data = [dict(r) for r in c.fetchall()]
    conn.close()
    return data


@safe_db_execute
def get_player_position(chat_id: int, user_id: int) -> int:
    player = get_player(chat_id, user_id)
    if not player:
        return 0
    conn = get_db()
    c = conn.cursor()
    c.execute(
        """
        SELECT COUNT(*) AS pos
        FROM players
        WHERE chat_id = ?
          AND (dungeon_rating > ?
               OR (dungeon_rating = ? AND level > ?))
        """,
        (
            chat_id,
            player["dungeon_rating"],
            player["dungeon_rating"],
            player["level"],
        ),
    )
    row = c.fetchone()
    conn.close()
    return int(row["pos"]) + 1


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸŽ¯ TELEGRAM HANDLERS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat = update.effective_chat
    user_id = user.id
    chat_id = chat.id

    if player_exists(chat_id, user_id):
        await show_main_menu(update, context)
        return

    text = f"""
ðŸŽ® Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² RuneQuestRPG, {user.first_name}!

Ð­Ñ‚Ð¾ Ð¿Ð¾Ð»Ð½Ð¾Ñ†ÐµÐ½Ð½Ð°Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð°Ñ RPG Ð² Telegram.

âš”ï¸ Ð’Ð«Ð‘Ð•Ð Ð˜ Ð¡Ð’ÐžÐ™ ÐšÐ›ÐÐ¡Ð¡:

ðŸ›¡ï¸ Ð’ÐžÐ˜Ð
   HP: 120 | ÐÑ‚Ð°ÐºÐ°: 15 | Ð—Ð°Ñ‰Ð¸Ñ‚Ð°: 8 | Ð‘Ð°Ð»Ð°Ð½Ñ

ðŸ”¥ ÐœÐÐ“
   HP: 70 | ÐÑ‚Ð°ÐºÐ°: 8 | Ð—Ð°Ñ‰Ð¸Ñ‚Ð°: 3 | ÐœÐ°Ð³Ð¸Ñ: 25

ðŸ—¡ï¸ Ð ÐÐ—Ð‘ÐžÐ™ÐÐ˜Ðš
   HP: 85 | ÐÑ‚Ð°ÐºÐ°: 19 | Ð—Ð°Ñ‰Ð¸Ñ‚Ð°: 5 | ÐšÑ€Ð¸Ñ‚: 22%

â›ª ÐŸÐÐ›ÐÐ”Ð˜Ð
   HP: 140 | ÐÑ‚Ð°ÐºÐ°: 13 | Ð—Ð°Ñ‰Ð¸Ñ‚Ð°: 15 | Ð¡Ð²ÐµÑ‚Ð»Ð°Ñ Ð¼Ð°Ð³Ð¸Ñ

ðŸ¹ Ð Ð•Ð™ÐÐ”Ð–Ð•Ð 
   HP: 95 | ÐÑ‚Ð°ÐºÐ°: 17 | Ð—Ð°Ñ‰Ð¸Ñ‚Ð°: 6 | Ð›Ð¾Ð²ÐºÐ¾ÑÑ‚ÑŒ

ðŸ’€ ÐÐ•ÐšÐ ÐžÐœÐÐÐ¢
   HP: 80 | ÐÑ‚Ð°ÐºÐ°: 10 | Ð—Ð°Ñ‰Ð¸Ñ‚Ð°: 4 | ÐœÐ°Ð³Ð¸Ñ: 30
"""

    keyboard = [
        [
            InlineKeyboardButton("âš”ï¸ Ð’Ð¾Ð¸Ð½", callback_data="class_warrior"),
            InlineKeyboardButton("ðŸ”¥ ÐœÐ°Ð³", callback_data="class_mage"),
        ],
        [
            InlineKeyboardButton("ðŸ—¡ï¸ Ð Ð°Ð·Ð±Ð¾Ð¹Ð½Ð¸Ðº", callback_data="class_rogue"),
            InlineKeyboardButton("â›ª ÐŸÐ°Ð»Ð°Ð´Ð¸Ð½", callback_data="class_paladin"),
        ],
        [
            InlineKeyboardButton("ðŸ¹ Ð ÐµÐ¹Ð½Ð´Ð¶ÐµÑ€", callback_data="class_ranger"),
            InlineKeyboardButton("ðŸ’€ ÐÐµÐºÑ€Ð¾Ð¼Ð°Ð½Ñ‚", callback_data="class_necromancer"),
        ],
    ]

    if update.message:
        await update.message.reply_text(
            text, reply_markup=InlineKeyboardMarkup(keyboard)
        )


async def select_class(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat
    user_id = user.id
    chat_id = chat.id

    class_name = query.data.replace("class_", "")

    created = init_player(
        chat_id, user_id, user.username or user.first_name, class_name
    )
    if not created:
        await query.answer("âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð¶Ð°", show_alert=True)
        return

    class_info = CLASSES[class_name]

    text = f"""
âœ… Ð¢Ð« Ð’Ð«Ð‘Ð ÐÐ› ÐšÐ›ÐÐ¡Ð¡!

{class_info['emoji']} {class_info['name'].upper()}

{class_info['description']}

ðŸ“Š ÐÐÐ§ÐÐ›Ð¬ÐÐ«Ð• Ð¥ÐÐ ÐÐšÐ¢Ð•Ð Ð˜Ð¡Ð¢Ð˜ÐšÐ˜:
â¤ï¸ HP: {class_info['health']}
ðŸ’™ ÐœÐ°Ð½Ð°: {class_info['mana']}
âš”ï¸ ÐÑ‚Ð°ÐºÐ°: {class_info['attack']}
ðŸ›¡ï¸ Ð—Ð°Ñ‰Ð¸Ñ‚Ð°: {class_info['defense']}
ðŸ’¥ ÐšÑ€Ð¸Ñ‚ ÑˆÐ°Ð½Ñ: {class_info['crit_chance']}%

ðŸ’° ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð¾Ð»Ð¾Ñ‚Ð¾: {class_info['starting_gold']}

ðŸŽ® Ð¢Ð²Ð¾Ñ‘ Ð¿Ñ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð² RuneQuestRPG Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ!
"""

    keyboard = [
        [InlineKeyboardButton("ðŸŽ® Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query if update.callback_query else None
    message = query.message if query else update.message
    user = update.effective_user
    chat = update.effective_chat

    player = get_player(chat.id, user.id)
    if not player:
        send = query.edit_message_text if query else message.reply_text
        await send("âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ /start Ð´Ð»Ñ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸.")
        return

    class_info = CLASSES[player["class"]]
    pet = PETS.get(player["pet_id"], PETS["wolf"])

    text = f"""
ðŸŽ® RUNEQUESTRPG - Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®

ðŸ‘¤ {user.first_name}
{class_info['emoji']} ÐšÐ»Ð°ÑÑ: {class_info['name']}
â­ Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ: {player['level']}/{MAX_LEVEL} | XP: {player['xp']}
â¤ï¸ HP: {player['health']}/{player['max_health']} | ðŸ’™ ÐœÐ°Ð½Ð°: {player['mana']}/{player['max_mana']}
ðŸ’° Ð—Ð¾Ð»Ð¾Ñ‚Ð¾: {player['gold']}

ðŸ¾ ÐŸÐ¸Ñ‚Ð¾Ð¼ÐµÑ†: {pet['emoji']} {pet['name']} (Ð£Ñ€. {player['pet_level']})

ðŸ† Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ Ð¿Ð¾Ð´Ð·ÐµÐ¼ÐµÐ»ÑŒÑ: {player['dungeon_rating']}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""

    keyboard = [
        [
            InlineKeyboardButton("ðŸ‘¤ ÐŸÐ ÐžÐ¤Ð˜Ð›Ð¬", callback_data="profile"),
            InlineKeyboardButton("ðŸŽ’ Ð˜ÐÐ’Ð•ÐÐ¢ÐÐ Ð¬", callback_data="inventory"),
        ],
        [
            InlineKeyboardButton("âš”ï¸ Ð‘ÐžÐ™", callback_data="start_fight"),
            InlineKeyboardButton("ðŸ° Ð›ÐžÐšÐÐ¦Ð˜Ð˜", callback_data="locations"),
        ],
        [
            InlineKeyboardButton("ðŸ”¨ ÐšÐ ÐÐ¤Ð¢", callback_data="crafting"),
            InlineKeyboardButton("ðŸ† ÐŸÐžÐ”Ð—Ð•ÐœÐ•Ð›Ð¬Ð•", callback_data="dungeon"),
        ],
        [
            InlineKeyboardButton("ðŸ“Š Ð Ð•Ð™Ð¢Ð˜ÐÐ“", callback_data="leaderboard"),
            InlineKeyboardButton("ðŸŽ ÐÐÐ“Ð ÐÐ”Ð«", callback_data="daily_reward"),
        ],
    ]

    if query:
        await query.edit_message_text(
            text, reply_markup=InlineKeyboardMarkup(keyboard)
        )
    else:
        if message:
            await message.reply_text(
                text, reply_markup=InlineKeyboardMarkup(keyboard)
            )


async def show_profile(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    player = get_player(chat.id, user.id)
    if not player:
        await query.answer("âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    class_info = CLASSES[player["class"]]
    xp_needed = int(LEVEL_UP_BASE * ((player["level"] + 1) ** 1.5))
    xp_percent = int(player["xp"] / max(xp_needed, 1) * 100)
    bar_filled = "â–ˆ" * (xp_percent // 10)
    bar_empty = "â–‘" * (10 - xp_percent // 10)
    pet = PETS.get(player["pet_id"], PETS["wolf"])

    text = f"""
ðŸ‘¤ ÐŸÐ ÐžÐ¤Ð˜Ð›Ð¬ Ð“Ð•Ð ÐžÐ¯

{class_info['emoji']} {class_info['name']}
â­ Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ: {player['level']}/{MAX_LEVEL}
ðŸ“Š ÐžÐ¿Ñ‹Ñ‚: {player['xp']}/{xp_needed} ({xp_percent}%)

{bar_filled}{bar_empty}

â¤ï¸ Ð—Ð´Ð¾Ñ€Ð¾Ð²ÑŒÐµ: {player['health']}/{player['max_health']}
ðŸ’™ ÐœÐ°Ð½Ð°: {player['mana']}/{player['max_mana']}
âš”ï¸ ÐÑ‚Ð°ÐºÐ°: {player['attack']}
ðŸ›¡ï¸ Ð—Ð°Ñ‰Ð¸Ñ‚Ð°: {player['defense']}

ðŸ’° Ð—Ð¾Ð»Ð¾Ñ‚Ð¾: {player['gold']}
ðŸ† Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³ Ð¿Ð¾Ð´Ð·ÐµÐ¼ÐµÐ»ÑŒÑ: {player['dungeon_rating']}

ðŸ¾ ÐŸÐ˜Ð¢ÐžÐœÐ•Ð¦:
{pet['emoji']} {pet['name']} (Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ {player['pet_level']})

ðŸ“ˆ Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ:
âš”ï¸ ÐŸÐ¾Ð±ÐµÐ´ Ð½Ð°Ð´ Ð¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ð¼Ð¸: {player['total_kills']}
ðŸ‘¹ Ð£Ð±Ð¸Ñ‚Ð¾ Ð±Ð¾ÑÑÐ¾Ð²: {player['total_bosses_killed']}
ðŸ° Ð ÐµÐ¹Ð´Ð¾Ð² Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾: {player['total_raids_completed']}
ðŸ’¥ Ð£Ñ€Ð¾Ð½Ð° Ð½Ð°Ð½ÐµÑÐµÐ½Ð¾: {player['total_damage_dealt']}
ðŸ˜¢ Ð£Ñ€Ð¾Ð½Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾: {player['total_damage_taken']}
ðŸŽ–ï¸ Ð‘Ð¾ÐµÐ² Ð²Ñ‹Ð¸Ð³Ñ€Ð°Ð½Ð¾: {player['total_battles_won']}
ðŸ“‰ Ð‘Ð¾ÐµÐ² Ð¿Ñ€Ð¾Ð¸Ð³Ñ€Ð°Ð½Ð¾: {player['total_battles_lost']}
âš”ï¸ ÐŸÐ’ÐŸ Ð¿Ð¾Ð±ÐµÐ´: {player['pvp_wins']}
âŒ ÐŸÐ’ÐŸ Ð¿Ð¾Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹: {player['pvp_losses']}
ðŸ”¨ ÐšÑ€Ð°Ñ„Ñ‚Ð¾Ð²: {player['craft_count']}
"""

    keyboard = [
        [InlineKeyboardButton("â¬…ï¸ Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def show_inventory(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    inventory = get_inventory(chat.id, user.id)
    player = get_player(chat.id, user.id)

    if not inventory:
        text = "ðŸŽ’ Ð˜ÐÐ’Ð•ÐÐ¢ÐÐ Ð¬\n\nâŒ Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ Ð¿ÑƒÑÑ‚"
    else:
        text = "ðŸŽ’ Ð˜ÐÐ’Ð•ÐÐ¢ÐÐ Ð¬\n\n"
        weapons_list = []
        armor_list = []
        materials_list = []
        potions_list = []
        runes_list = []
        other_list = []

        for item in inventory:
            iid = item["item_id"]
            if iid in WEAPONS:
                weapons_list.append(item)
            elif iid in ARMOR:
                armor_list.append(item)
            elif iid in MATERIALS:
                materials_list.append(item)
            elif iid in RUNES:
                runes_list.append(item)
            elif item["item_type"] == "potion":
                potions_list.append(item)
            else:
                other_list.append(item)

        if weapons_list:
            text += "âš”ï¸ ÐžÐ Ð£Ð–Ð˜Ð•:\n"
            for item in weapons_list:
                w = WEAPONS[item["item_id"]]
                equipped_mark = (
                    " (Ð­ÐºÐ¸Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾)"
                    if player.get("equipped_weapon") == item["item_id"]
                    else ""
                )
                text += (
                    f"  {w['emoji']} {w['name']} x{item['quantity']}{equipped_mark}\n"
                )

        if armor_list:
            text += "\nðŸ›¡ï¸ Ð‘Ð ÐžÐÐ¯:\n"
            for item in armor_list:
                a = ARMOR[item["item_id"]]
                equipped_mark = (
                    " (Ð­ÐºÐ¸Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾)"
                    if player.get("equipped_armor") == item["item_id"]
                    else ""
                )
                text += (
                    f"  {a['emoji']} {a['name']} x{item['quantity']}{equipped_mark}\n"
                )

        if runes_list:
            text += "\nðŸ”® Ð Ð£ÐÐ«:\n"
            for item in runes_list:
                r = RUNES[item["item_id"]]
                eq = (
                    " (ÐÐºÑ‚Ð¸Ð²Ð½Ð°)"
                    if player.get("equipped_rune") == item["item_id"]
                    else ""
                )
                text += (
                    f"  {r['emoji']} {r['name']} x{item['quantity']}{eq}\n"
                )

        if materials_list:
            text += "\nðŸ“¦ ÐœÐÐ¢Ð•Ð Ð˜ÐÐ›Ð«:\n"
            for item in materials_list:
                m = MATERIALS[item["item_id"]]
                text += f"  {m['emoji']} {m['name']} x{item['quantity']}\n"

        if potions_list:
            text += "\nðŸ§ª Ð—Ð•Ð›Ð¬Ð¯:\n"
            for item in potions_list:
                text += f"  ðŸ§ª {item['item_id']} x{item['quantity']}\n"

        if other_list:
            text += "\nðŸ“œ ÐŸÐ ÐžÐ§Ð•Ð•:\n"
            for item in other_list:
                text += f"  {item['item_id']} x{item['quantity']}\n"

    keyboard = [
        [InlineKeyboardButton("â¬…ï¸ Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def start_fight(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    if get_active_battle(chat.id, user.id):
        await query.answer("âš ï¸ Ð¢Ñ‹ ÑƒÐ¶Ðµ Ð² Ð±Ð¾ÑŽ!", show_alert=True)
        return

    player = get_player(chat.id, user.id)
    if not player:
        await query.answer("âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    enemy = start_battle(chat.id, user.id)
    if not enemy:
        await query.answer("âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ Ð±Ð¾Ð¹", show_alert=True)
        return

    text = f"""
âš”ï¸ Ð‘ÐžÐ™ ÐÐÐ§ÐÐ›Ð¡Ð¯!

ÐŸÑ€Ð¾Ñ‚Ð¸Ð²Ð½Ð¸Ðº: {enemy['enemy_emoji']} {enemy['enemy_name']} (Ð£Ñ€. {enemy['enemy_level']})

â¤ï¸ Ð’Ñ€Ð°Ð³ HP: {enemy['enemy_health']}/{enemy['enemy_max_health']}
âš”ï¸ Ð’Ñ€Ð°Ð³ ÑƒÑ€Ð¾Ð½: {enemy['enemy_damage']}
{'ðŸ‘¹ Ð‘ÐžÐ¡Ð¡' if enemy['is_boss'] else ''}

{'â”€' * 35}

Ð¢Ð²Ð¾Ð¸ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸:
â¤ï¸ HP: {player['health']}/{player['max_health']}
âš”ï¸ ÐÑ‚Ð°ÐºÐ°: {player['attack']}
ðŸ›¡ï¸ Ð—Ð°Ñ‰Ð¸Ñ‚Ð°: {player['defense']}

Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:
"""

    keyboard = [
        [InlineKeyboardButton("âš”ï¸ ÐÐ¢ÐÐšÐžÐ’ÐÐ¢Ð¬", callback_data="attack")],
        [InlineKeyboardButton("ðŸ§ª Ð—Ð•Ð›Ð¬Ð•", callback_data="use_potion")],
        [
            InlineKeyboardButton("ðŸƒ Ð¡Ð‘Ð•Ð–ÐÐ¢Ð¬", callback_data="escape"),
            InlineKeyboardButton("âŒ Ð¡Ð”ÐÐ¢Ð¬Ð¡Ð¯", callback_data="surrender"),
        ],
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def attack(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    player = get_player(chat.id, user.id)
    if not player:
        await query.answer("âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    battle_result = perform_attack(chat.id, user.id)
    if not battle_result.get("success"):
        await query.answer(battle_result.get("message", "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°"), show_alert=True)
        return

    text = f"""
âš”ï¸ Ð‘ÐžÐ™

Ð¢Ð²Ð¾Ñ Ð°Ñ‚Ð°ÐºÐ°: {"ðŸ’¥" if battle_result['is_crit'] else ""} {battle_result['damage']} ÑƒÑ€Ð¾Ð½Ð°
{"âœ¨ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð™ Ð£Ð”ÐÐ !" if battle_result['is_crit'] else ""}

â¤ï¸ Ð’Ñ€Ð°Ð³ HP: {battle_result['enemy_hp']}/{battle_result['enemy_max_hp']}

"""

    if battle_result.get("victory"):
        text += f"""
ðŸŽ‰ ÐŸÐžÐ‘Ð•Ð”Ð!

ÐÐ°Ð³Ñ€Ð°Ð´Ñ‹:
â­ ÐžÐ¿Ñ‹Ñ‚: +{battle_result['xp_gained']}
ðŸ’° Ð—Ð¾Ð»Ð¾Ñ‚Ð¾: +{battle_result['gold_gained']}
"""
        if battle_result.get("loot"):
            loot_info = MATERIALS.get(battle_result["loot"], {})
            text += (
                f"ðŸŽ Ð›ÑƒÑ‚: {loot_info.get('emoji', '?')} "
                f"{loot_info.get('name', 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾')}\n"
            )
        if battle_result.get("levels_up", 0) > 0:
            text += (
                f"\nðŸ†™ Ð£Ð ÐžÐ’Ð•ÐÐ¬ ÐŸÐžÐ’Ð«Ð¨Ð•Ð! +{battle_result['levels_up']} ÑƒÑ€Ð¾Ð²Ð½ÐµÐ¹"
            )
        keyboard = [
            [InlineKeyboardButton("ðŸŽ® Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
        ]
    elif battle_result.get("defeat"):
        text += f"""
ðŸ‘¹ Ð’Ñ€Ð°Ð³ Ð½Ð°Ð½Ð¾ÑÐ¸Ñ‚ Ñ€ÐµÑˆÐ°ÑŽÑ‰Ð¸Ð¹ ÑƒÐ´Ð°Ñ€!
ðŸ’€ ÐŸÐžÐ ÐÐ–Ð•ÐÐ˜Ð•!

Ð¢Ñ‹ Ð¿Ð¾Ð²ÐµÑ€Ð¶ÐµÐ½ Ð²Ñ€Ð°Ð³Ð¾Ð¼...
â¤ï¸ HP: 0/{player['max_health']}

ÐŸÐ¾Ñ‚ÐµÑ€ÑÐ½Ð¾ Ð·Ð¾Ð»Ð¾Ñ‚Ð°: -{battle_result['gold_lost']}
"""
        keyboard = [
            [InlineKeyboardButton("ðŸŽ® Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
        ]
    else:
        text += f"""
ðŸ‘¹ Ð’Ñ€Ð°Ð³ Ð°Ñ‚Ð°ÐºÑƒÐµÑ‚: {battle_result['enemy_attack']} ÑƒÑ€Ð¾Ð½Ð°
â¤ï¸ Ð¢Ð²Ð¾Ð¹ HP: {battle_result['player_hp']}/{battle_result['player_max_hp']}

{'â”€' * 35}

Ð’Ñ‹Ð±ÐµÑ€Ð¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:
"""
        keyboard = [
            [InlineKeyboardButton("âš”ï¸ ÐÐ¢ÐÐšÐžÐ’ÐÐ¢Ð¬", callback_data="attack")],
            [InlineKeyboardButton("ðŸ§ª Ð—Ð•Ð›Ð¬Ð•", callback_data="use_potion")],
            [
                InlineKeyboardButton("ðŸƒ Ð¡Ð‘Ð•Ð–ÐÐ¢Ð¬", callback_data="escape"),
                InlineKeyboardButton("âŒ Ð¡Ð”ÐÐ¢Ð¬Ð¡Ð¯", callback_data="surrender"),
            ],
        ]

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def use_potion(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    player = get_player(chat.id, user.id)
    battle = get_active_battle(chat.id, user.id)
    if not player or not battle:
        await query.answer("âŒ Ð‘Ð¾Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    if get_material(chat.id, user.id, "health_potion") <= 0:
        await query.answer("âŒ ÐÐµÑ‚ Ð·ÐµÐ»Ð¸Ð¹ Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ", show_alert=True)
        return

    remove_item(chat.id, user.id, "health_potion")
    heal_amount = int(player["max_health"] * 0.5)
    new_hp = min(player["max_health"], player["health"] + heal_amount)

    conn = get_db()
    c = conn.cursor()
    c.execute(
        "UPDATE players SET health = ? WHERE user_id = ? AND chat_id = ?",
        (new_hp, user.id, chat.id),
    )
    conn.commit()
    conn.close()

    enemy = ENEMIES[battle["enemy_id"]]
    class_info = CLASSES.get(player["class"], {})
    enemy_damage, _ = calculate_damage(
        battle["enemy_damage"],
        player["defense"],
        attacker_crit_chance=5,
        spell_power=0,
        attacker_element=enemy.get("element", Element.PHYSICAL.value),
        defender_element=class_info.get("element", Element.PHYSICAL.value),
    )
    new_player_hp = new_hp - enemy_damage

    text = f"""
ðŸ§ª Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐÐž Ð—Ð•Ð›Ð¬Ð•!

ðŸ’š Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ HP: +{heal_amount}
â¤ï¸ Ð¢Ð²Ð¾Ð¹ HP: {new_hp}/{player['max_health']}

ðŸ‘¹ Ð’Ñ€Ð°Ð³ Ð°Ñ‚Ð°ÐºÑƒÐµÑ‚!
Ð’Ñ€Ð°Ð³ Ð½Ð°Ð½Ð¾ÑÐ¸Ñ‚: {enemy_damage} ÑƒÑ€Ð¾Ð½Ð°
â¤ï¸ Ð¢Ð²Ð¾Ð¹ HP: {max(0, new_player_hp)}/{player['max_health']}
"""

    if new_player_hp <= 0:
        text += "\nðŸ’€ ÐŸÐžÐ ÐÐ–Ð•ÐÐ˜Ð•!"
        keyboard = [
            [InlineKeyboardButton("ðŸŽ® Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
        ]
        end_battle(chat.id, user.id)
        conn = get_db()
        c = conn.cursor()
        c.execute(
            """
            UPDATE players SET health = max_health,
                               total_battles_lost = total_battles_lost + 1,
                               total_damage_taken = total_damage_taken + ?
            WHERE user_id = ? AND chat_id = ?
            """,
            (enemy_damage, user.id, chat.id),
        )
        conn.commit()
        conn.close()
    else:
        conn = get_db()
        c = conn.cursor()
        c.execute(
            """
            UPDATE players SET health = ?, total_damage_taken = total_damage_taken + ?
            WHERE user_id = ? AND chat_id = ?
            """,
            (new_player_hp, enemy_damage, user.id, chat.id),
        )
        conn.commit()
        conn.close()

        keyboard = [
            [InlineKeyboardButton("âš”ï¸ ÐÐ¢ÐÐšÐžÐ’ÐÐ¢Ð¬", callback_data="attack")],
            [InlineKeyboardButton("ðŸ§ª Ð—Ð•Ð›Ð¬Ð•", callback_data="use_potion")],
            [
                InlineKeyboardButton("ðŸƒ Ð¡Ð‘Ð•Ð–ÐÐ¢Ð¬", callback_data="escape"),
                InlineKeyboardButton("âŒ Ð¡Ð”ÐÐ¢Ð¬Ð¡Ð¯", callback_data="surrender"),
            ],
        ]

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def escape(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    player = get_player(chat.id, user.id)
    battle = get_active_battle(chat.id, user.id)
    if not player or not battle:
        await query.answer("âŒ Ð‘Ð¾Ð¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    if random.randint(1, 100) <= 50:
        end_battle(chat.id, user.id)
        conn = get_db()
        c = conn.cursor()
        c.execute(
            "UPDATE players SET health = max_health WHERE user_id = ? AND chat_id = ?",
            (user.id, chat.id),
        )
        conn.commit()
        conn.close()
        text = """
ðŸƒ Ð£Ð¡ÐŸÐ•Ð¨ÐÐž Ð¡Ð‘Ð•Ð–ÐÐ›!

Ð¢Ñ‹ ÑÐ±ÐµÐ¶Ð°Ð» Ð¾Ñ‚ Ð²Ñ€Ð°Ð³Ð° Ð¸ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð» Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ HP.
"""
        keyboard = [
            [InlineKeyboardButton("ðŸŽ® Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
        ]
    else:
        enemy = ENEMIES[battle["enemy_id"]]
        class_info = CLASSES.get(player["class"], {})
        enemy_damage, _ = calculate_damage(
            battle["enemy_damage"],
            player["defense"],
            attacker_crit_chance=5,
            spell_power=0,
            attacker_element=enemy.get("element", Element.PHYSICAL.value),
            defender_element=class_info.get("element", Element.PHYSICAL.value),
        )
        new_player_hp = player["health"] - enemy_damage
        text = f"""
âŒ ÐŸÐžÐŸÐ«Ð¢ÐšÐ ÐŸÐžÐ‘Ð•Ð“Ð ÐÐ• Ð£Ð”ÐÐ›ÐÐ¡Ð¬!

Ð’Ñ€Ð°Ð³ Ð½Ð°Ð½Ð¾ÑÐ¸Ñ‚ ÑƒÐ´Ð°Ñ€: {enemy_damage} ÑƒÑ€Ð¾Ð½Ð°
â¤ï¸ Ð¢Ð²Ð¾Ð¹ HP: {max(0, new_player_hp)}/{player['max_health']}
"""
        if new_player_hp <= 0:
            text += "\nðŸ’€ ÐŸÐžÐ ÐÐ–Ð•ÐÐ˜Ð•!"
            end_battle(chat.id, user.id)
            keyboard = [
                [InlineKeyboardButton("ðŸŽ® Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
            ]
            conn = get_db()
            c = conn.cursor()
            c.execute(
                """
                UPDATE players SET health = max_health,
                                   total_battles_lost = total_battles_lost + 1,
                                   total_damage_taken = total_damage_taken + ?
                WHERE user_id = ? AND chat_id = ?
                """,
                (enemy_damage, user.id, chat.id),
            )
            conn.commit()
            conn.close()
        else:
            conn = get_db()
            c = conn.cursor()
            c.execute(
                """
                UPDATE players SET health = ?, total_damage_taken = total_damage_taken + ?
                WHERE user_id = ? AND chat_id = ?
                """,
                (new_player_hp, enemy_damage, user.id, chat.id),
            )
            conn.commit()
            conn.close()
            text += "\nÐ’Ñ‹Ð±ÐµÑ€Ð¸ Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÐµÐµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:"
            keyboard = [
                [InlineKeyboardButton("âš”ï¸ ÐÐ¢ÐÐšÐžÐ’ÐÐ¢Ð¬", callback_data="attack")],
                [InlineKeyboardButton("ðŸ§ª Ð—Ð•Ð›Ð¬Ð•", callback_data="use_potion")],
                [
                    InlineKeyboardButton("ðŸƒ Ð¡Ð‘Ð•Ð–ÐÐ¢Ð¬", callback_data="escape"),
                    InlineKeyboardButton("âŒ Ð¡Ð”ÐÐ¢Ð¬Ð¡Ð¯", callback_data="surrender"),
                ],
            ]

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def surrender(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    end_battle(chat.id, user.id)
    text = """
ðŸ³ï¸ Ð¢Ð« Ð¡Ð”ÐÐ›Ð¡Ð¯

Ð¢Ñ‹ Ð¿Ð¾ÐºÐ¸Ð½ÑƒÐ» Ð¿Ð¾Ð»Ðµ Ð±Ð¾Ñ, Ð¾Ñ‚ÐºÐ°Ð·Ð°Ð²ÑˆÐ¸ÑÑŒ Ð¾Ñ‚ ÑÐ»Ð°Ð²Ñ‹.
"""
    keyboard = [
        [InlineKeyboardButton("ðŸŽ® Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def crafting(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    text = """
ðŸ”¨ ÐšÐ ÐÐ¤Ð¢Ð˜ÐÐ“

Ð’Ñ‹Ð±ÐµÑ€Ð¸, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‡ÐµÑˆÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ:
"""
    keyboard = []
    for recipe_id, recipe in list(CRAFTING_RECIPES.items()):
        keyboard.append(
            [
                InlineKeyboardButton(
                    f"{recipe['emoji']} {recipe['name']}",
                    callback_data=f"craft_{recipe_id}",
                )
            ]
        )
    keyboard.append(
        [InlineKeyboardButton("â¬…ï¸ Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
    )
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def craft(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    recipe_id = query.data.replace("craft_", "")
    recipe = CRAFTING_RECIPES.get(recipe_id)
    if not recipe:
        await query.answer("âŒ Ð ÐµÑ†ÐµÐ¿Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    player = get_player(chat.id, user.id)
    if not player:
        await query.answer("âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    text = f"""
ðŸ”¨ Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð•: {recipe['emoji']} {recipe['name']}

Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ:
"""
    has_all = True
    for material, needed in recipe["materials"].items():
        have = get_material(chat.id, user.id, material)
        material_info = MATERIALS[material]
        status = "âœ…" if have >= needed else "âŒ"
        text += (
            f"{status} {material_info['emoji']} "
            f"{material_info['name']} ({have}/{needed})\n"
        )
        if have < needed:
            has_all = False
    gold_ok = player["gold"] >= recipe["gold"]
    level_ok = player["level"] >= recipe["level"]
    text += (
        f"ðŸ’° Ð—Ð¾Ð»Ð¾Ñ‚Ð¾: {'âœ…' if gold_ok else 'âŒ'} "
        f"({player['gold']}/{recipe['gold']})\n"
    )
    text += (
        f"â­ Ð£Ñ€Ð¾Ð²ÐµÐ½ÑŒ: {'âœ…' if level_ok else 'âŒ'} "
        f"({player['level']}/{recipe['level']})\n"
    )

    if has_all and gold_ok and level_ok:
        keyboard = [
            [
                InlineKeyboardButton(
                    "âœ… Ð¡ÐžÐ—Ð”ÐÐ¢Ð¬", callback_data=f"craft_confirm_{recipe_id}"
                )
            ],
            [InlineKeyboardButton("â¬…ï¸ ÐÐÐ—ÐÐ”", callback_data="crafting")],
        ]
    else:
        keyboard = [
            [InlineKeyboardButton("â¬…ï¸ ÐÐÐ—ÐÐ”", callback_data="crafting")]
        ]

    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def craft_confirm(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    recipe_id = query.data.replace("craft_confirm_", "")
    result = craft_item(chat.id, user.id, recipe_id)
    if not result["success"]:
        await query.answer(result["message"], show_alert=True)
        return

    text = f"""
âœ… Ð¡ÐžÐ—Ð”ÐÐÐž!

ðŸŽ Ð¢Ñ‹ ÑÐ¾Ð·Ð´Ð°Ð»: {result['name']}

ÐŸÑ€ÐµÐ´Ð¼ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ.
"""
    keyboard = [
        [InlineKeyboardButton("ðŸ”¨ ÐÐÐ—ÐÐ” Ðš ÐšÐ ÐÐ¤Ð¢Ð£", callback_data="crafting")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def show_leaderboard(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    leaders = get_leaderboard(chat.id, 10)
    player_position = get_player_position(chat.id, user.id)
    player = get_player(chat.id, user.id)

    text = "ðŸ† Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð Ð›Ð˜Ð”Ð•Ð ÐžÐ’ RUNEQUESTRPG ðŸ†\n\n"
    for i, leader in enumerate(leaders, 1):
        if i == 1:
            medal = "ðŸ‘‘"
        elif i == 2:
            medal = "ðŸ¥ˆ"
        elif i == 3:
            medal = "ðŸ¥‰"
        else:
            medal = f"{i}."
        text += (
            f"{medal} {leader['username']} - Ð­Ñ‚Ð°Ð¶ {leader['dungeon_rating']} | "
            f"Ð£Ñ€. {leader['level']} | ðŸ’°{leader['gold']}\n"
        )

    text += f"""

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Ð¢Ð²Ð¾Ñ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ñ: #{player_position}
Ð¢Ð²Ð¾Ð¹ Ñ€ÐµÐºÐ¾Ñ€Ð´: Ð­Ñ‚Ð°Ð¶ {player['dungeon_rating']}
Ð¢Ð²Ð¾Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ: {player['level']}
Ð¢Ð²Ð¾Ñ‘ Ð·Ð¾Ð»Ð¾Ñ‚Ð¾: {player['gold']}
"""

    keyboard = [
        [InlineKeyboardButton("â¬…ï¸ Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def locations(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query

    text = "ðŸ° Ð’Ð«Ð‘Ð•Ð Ð˜ Ð›ÐžÐšÐÐ¦Ð˜Ð®:\n\n"
    keyboard = []
    for loc_id, loc in LOCATIONS.items():
        text += (
            f"{loc['emoji']} {loc['name']} (Ð£Ñ€. {loc['min_level']}-"
            f"{loc['max_level']})\n"
        )
        keyboard.append(
            [
                InlineKeyboardButton(
                    f"{loc['emoji']} {loc['name']}",
                    callback_data=f"location_{loc_id}",
                )
            ]
        )
    keyboard.append(
        [InlineKeyboardButton("â¬…ï¸ Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
    )
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def select_location(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    location_id = query.data.replace("location_", "")
    location = LOCATIONS.get(location_id)
    if not location:
        await query.answer("âŒ Ð›Ð¾ÐºÐ°Ñ†Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°", show_alert=True)
        return

    player = get_player(chat.id, user.id)
    if not player:
        await query.answer("âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    text = f"""
{location['emoji']} {location['name'].upper()}

{location['description']}

Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÐ¼Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ: {location['min_level']}-{location['max_level']}
Ð¢Ð²Ð¾Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ: {player['level']}

{"âš ï¸ Ð¢ÐµÐ±Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð¿Ñ€Ð¾ÐºÐ°Ñ‡Ð°Ñ‚ÑŒÑÑ Ð¿ÐµÑ€ÐµÐ´ Ð²Ñ…Ð¾Ð´Ð¾Ð¼!" if player['level'] < location['min_level'] else "âœ… Ð¢Ñ‹ Ð³Ð¾Ñ‚Ð¾Ð²!"}

Ð’Ñ€Ð°Ð³Ð¸ Ð² ÑÑ‚Ð¾Ð¹ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸:
"""
    for enemy_id in location["enemies"]:
        enemy = ENEMIES[enemy_id]
        text += f"\n{enemy['emoji']} {enemy['name']} (Ð£Ñ€. {enemy['level']})"

    keyboard = [
        [InlineKeyboardButton("âš”ï¸ ÐÐÐ§ÐÐ¢Ð¬ Ð‘ÐžÐ™", callback_data="start_fight")],
        [InlineKeyboardButton("â¬…ï¸ ÐÐÐ—ÐÐ”", callback_data="locations")],
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def dungeon_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    player = get_player(chat.id, user.id)
    if not player:
        await query.answer("âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    text = f"""
ðŸ† Ð Ð•Ð™Ð¢Ð˜ÐÐ“ÐžÐ’ÐžÐ• ÐŸÐžÐ”Ð—Ð•ÐœÐ•Ð›Ð¬Ð• RUNEQUESTRPG

ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:
Ð‘ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾Ðµ Ð¿Ð¾Ð´Ð·ÐµÐ¼ÐµÐ»ÑŒÐµ Ñ Ð½Ð°Ñ€Ð°ÑÑ‚Ð°ÑŽÑ‰ÐµÐ¹ ÑÐ»Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒÑŽ.
Ð’Ñ€Ð°Ð³Ð¸ ÑÑ‚Ð°Ð½Ð¾Ð²ÑÑ‚ÑÑ ÑÐ¸Ð»ÑŒÐ½ÐµÐµ Ñ ÐºÐ°Ð¶Ð´Ñ‹Ð¼ ÑÑ‚Ð°Ð¶Ð¾Ð¼.
HP Ð½Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð¼ÐµÐ¶Ð´Ñƒ Ð±Ð¾ÑÐ¼Ð¸.
Ð§ÐµÐ¼ Ð³Ð»ÑƒÐ±Ð¶Ðµ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÑˆÑŒ â€” Ñ‚ÐµÐ¼ Ð²Ñ‹ÑˆÐµ Ñ‚Ð²Ð¾Ð¹ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³.

Ð¢Ð²Ð¾Ð¹ Ñ€ÐµÐºÐ¾Ñ€Ð´: Ð­Ñ‚Ð°Ð¶ {player['dungeon_rating']}

âš ï¸ ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ:
ÐŸÑ€Ð¸ ÑÐ¼ÐµÑ€Ñ‚Ð¸ Ð² Ð¿Ð¾Ð´Ð·ÐµÐ¼ÐµÐ»ÑŒÐµ Ñ‚Ñ‹ Ð²Ñ‹Ð»ÐµÑ‚Ð°ÐµÑˆÑŒ Ð¸ Ð±Ð¾Ð¹ Ð·Ð°ÐºÐ°Ð½Ñ‡Ð¸Ð²Ð°ÐµÑ‚ÑÑ.
Ð£Ð±ÐµÐ´Ð¸ÑÑŒ, Ñ‡Ñ‚Ð¾ Ð³Ð¾Ñ‚Ð¾Ð² Ðº ÑÐ»Ð¾Ð¶Ð½Ñ‹Ð¼ ÑÑ€Ð°Ð¶ÐµÐ½Ð¸ÑÐ¼!

Ð“Ð¾Ñ‚Ð¾Ð² Ð²Ð¾Ð¹Ñ‚Ð¸?
"""

    keyboard = [
        [
            InlineKeyboardButton(
                "ðŸšª Ð’ÐžÐ™Ð¢Ð˜ Ð’ ÐŸÐžÐ”Ð—Ð•ÐœÐ•Ð›Ð¬Ð•", callback_data="dungeon_start"
            )
        ],
        [InlineKeyboardButton("â¬…ï¸ Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")],
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


async def daily_reward(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat

    player = get_player(chat.id, user.id)
    if not player:
        await query.answer("âŒ Ð˜Ð³Ñ€Ð¾Ðº Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½", show_alert=True)
        return

    if player["last_daily_reward"]:
        last_reward = datetime.fromisoformat(player["last_daily_reward"])
        if datetime.now() - last_reward < timedelta(hours=24):
            await query.answer("â³ ÐÐ°Ð³Ñ€Ð°Ð´Ð° ÑƒÐ¶Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð°, Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸ Ð·Ð°Ð²Ñ‚Ñ€Ð°", show_alert=True)
            return

    reward_gold = random.randint(120, 520)
    reward_xp = random.randint(60, 260)
    add_gold(chat.id, user.id, reward_gold)
    add_xp(chat.id, user.id, player["username"], reward_xp)

    conn = get_db()
    c = conn.cursor()
    c.execute(
        """
        UPDATE players SET last_daily_reward = CURRENT_TIMESTAMP
        WHERE user_id = ? AND chat_id = ?
        """,
        (user.id, chat.id),
    )
    conn.commit()
    conn.close()

    text = f"""
ðŸŽ Ð•Ð–Ð•Ð”ÐÐ•Ð’ÐÐÐ¯ ÐÐÐ“Ð ÐÐ”Ð RUNEQUESTRPG!

ðŸ’° Ð—Ð¾Ð»Ð¾Ñ‚Ð¾: +{reward_gold}
â­ ÐžÐ¿Ñ‹Ñ‚: +{reward_xp}

ÐŸÑ€Ð¸Ñ…Ð¾Ð´Ð¸ Ð·Ð°Ð²Ñ‚Ñ€Ð° Ð·Ð° Ð½Ð¾Ð²Ð¾Ð¹ Ð½Ð°Ð³Ñ€Ð°Ð´Ð¾Ð¹!
"""
    keyboard = [
        [InlineKeyboardButton("â¬…ï¸ Ð“Ð›ÐÐ’ÐÐžÐ• ÐœÐ•ÐÐ®", callback_data="main_menu")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ðŸš€ Ð“Ð›ÐÐ’ÐÐÐ¯ Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


async def main():
    init_database()
    app = (
        Application.builder()
        .token(BOT_TOKEN)
        .read_timeout(30)
        .write_timeout(30)
        .build()
    )

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(select_class, pattern="^class_"))
    app.add_handler(CallbackQueryHandler(show_main_menu, pattern="^main_menu$"))
    app.add_handler(CallbackQueryHandler(show_profile, pattern="^profile$"))
    app.add_handler(CallbackQueryHandler(show_inventory, pattern="^inventory$"))
    app.add_handler(CallbackQueryHandler(start_fight, pattern="^start_fight$"))
    app.add_handler(CallbackQueryHandler(attack, pattern="^attack$"))
    app.add_handler(CallbackQueryHandler(use_potion, pattern="^use_potion$"))
    app.add_handler(CallbackQueryHandler(escape, pattern="^escape$"))
    app.add_handler(CallbackQueryHandler(surrender, pattern="^surrender$"))
    app.add_handler(CallbackQueryHandler(crafting, pattern="^crafting$"))
    app.add_handler(CallbackQueryHandler(craft, pattern="^craft_[a-z_]+$"))
    app.add_handler(
        CallbackQueryHandler(craft_confirm, pattern="^craft_confirm_[a-z_]+$")
    )
    app.add_handler(CallbackQueryHandler(show_leaderboard, pattern="^leaderboard$"))
    app.add_handler(CallbackQueryHandler(locations, pattern="^locations$"))
    app.add_handler(CallbackQueryHandler(select_location, pattern="^location_"))
    app.add_handler(CallbackQueryHandler(dungeon_menu, pattern="^dungeon$"))
    app.add_handler(CallbackQueryHandler(daily_reward, pattern="^daily_reward$"))

    logger.info("âœ… RuneQuestRPG BOT Ð—ÐÐŸÐ£Ð©Ð•Ð!")
    await app.run_polling()


if __name__ == "__main__":
    asyncio.run(main())

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â„¹ï¸ ÐŸÐ Ð˜ÐœÐ•Ð§ÐÐÐ˜Ð•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ð˜Ð·-Ð·Ð° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼Ñ‹ ÐºÐ¾Ð´ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ñ„Ð¸Ð·Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ€Ð¾Ð²Ð½Ð¾ 7000 ÑÑ‚Ñ€Ð¾Ðº
# Ð² Ð¾Ð´Ð½Ð¾Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚Ðµ, Ð½Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸ÑŽ: Ñ‚Ñ‹ Ð¼Ð¾Ð¶ÐµÑˆÑŒ
# Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ñ… Ð²Ñ€Ð°Ð³Ð¾Ð², Ñ€ÐµÑ†ÐµÐ¿Ñ‚Ñ‹, Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸, Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¸ Ñ‚.Ð´. Ð¿Ð¾ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ð¸.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
